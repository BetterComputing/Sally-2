SALLY-F000.asm:
     1                          ;--------------------------------------------------
     2                          ; Init Sequence
     3                          ;--------------------------------------------------
     4                          ; 50	01	Bit0	set ATARI DATA
     5                          ; 51	01 	Bit1	set RS232 TX
     6                          ; 80	03	CTC	Channel 0 reset
     7                          ; 80	10	CTC	Channel 0 interrupt vector
     8                          ; 81	07     	CTC	Channel 1 reset + set time constant
     9                          ; 81	01	CTC	Channel 1 time contant 1
    10                          ; 82	03 	CTC	Channel 2 reset
    11                          ; 83	03     	CTC	Channel 3 reset
    12                          ; 57	01	Bit7	ATARI 0=!CMD / *** 1=RXD ***
    13                          ; 30	00 	DSE	Floppy Control (74LS273) 0=Drive1,  1=Drive2,  2=Drive3,  3=Drive4,  4=Reset FDC,  5=Side,  6=B\S,  7=S/D\
    14                          ; 40	d0      DWR/DRW	FDC read-write	d0 = force int (with no interrupt)
    15                          ;--------------------------------------------------
    16                          ; out\ ports
    17                          ;--------------------------------------------------
    18                          ; $2x 	Printer DATA
    19                          ; $3x	Floppy Control	D7 = S/D\, D6 = HD\/S, D5 = Side, D4 = FDCRES, D3 = DSEL4, D2 = DSEL3, D1 = DSEL1, D0 = DSEL0
    20                          ; $4x	FDC 1797
    21                          ; $5x	U52 74LS259
    22                          ; 	$50	ATARI Out data
    23                          ; 	$51	RS232 TX
    24                          ; 	$52	ROM switch	(0 = ROM, 1 = RAM)
    25                          ; 	$53	printer strobe
    26                          ; 	$54	reset index-pulse
    27                          ; 	$55	RS232 DTR
    28                          ; 	$56	set index pulse
    29                          ; 	$57	0=CMD,  1=SIO
    30                          ; $8x	CTC
    31                          ;--------------------------------------------------
    32                          ; in\ ports
    33                          ;--------------------------------------------------
    34                          ; $2x	Printer Control
    35                          ; $4x	FDC 1797
    36                          ; $5x	RS232	D7=RX,  D3=1,  D2=?,  D1=FlowControl
    37                          ; $70	SIO	D7=RX,  D3=RDY/+5V, D1=CMD
    38                          
    39                          		include "SALLY-CONST.asm"
SALLY-CONST.asm:
     1                          LF		equ	0ah
     2                          CR		equ	0dh
     3                          
     4                          VARS		equ	0ff80h
     5                          echo		equ	0
     6                          sum		equ	1
     7                          addr		equ	2
     8                          
     9                          ;--------------------------------------------------
    10                          ; baudrate for console-io
    11                          ; 26 =  9600 baud
    12                          ; 13 = 19200 baud
    13                          ;--------------------------------------------------
    14                          CONBAUD		equ	26
    15                          
    16                          ;--------------------------------------------------
    17                          ; 16 bytes keyboard buffer
    18                          ;--------------------------------------------------
    19                          KEYBUF		equ	0ff00h
    20                          
    21                          ;--------------------------------------------------
    22                          ; NMI Vector
    23                          ;--------------------------------------------------
    24                          NMIVEC		equ	066h
    25                          
    26                          ;--------------------------------------------------
    27                          ; FF10: Interrupt Table
    28                          ;--------------------------------------------------
    29                          TC0INTVEC	equ	0ff10h
    30                          TC1INTVEC	equ	0ff12h
    31                          TC2INTVEC	equ	0ff14h
    32                          TC3INTVEC	equ	0ff16h
    33                          
    34                          ;--------------------------------------------------
    35                          ; Out - ports equations, Disk-Control
    36                          ;--------------------------------------------------
    37                          DISKCTRL	equ	030h				;7 = S/D\, 6 = S/B\, 5 = side, 4 = RES\, 3-0 = DSEL 4-1
    38                          
    39                          ;--------------------------------------------------
    40                          ; In/Out - ports equations, WD177x FDC
    41                          ;--------------------------------------------------
    42                          FDCSTAT		equ	040h
    43                          FDCCMD		equ	040h
    44                          FDCTRK		equ	041h
    45                          FDCSEC		equ	042h
    46                          FDCDAT		equ	043h
    47                          
    48                          ;--------------------------------------------------
    49                          ; Out - ports equations, RS232, SIO, ROM, INDEX
    50                          ;--------------------------------------------------
    51                          SIOOUT		equ	050h
    52                          RS232TX		equ	051h
    53                          ROMSWITCH	equ	052h
    54                          STROBE		equ	053h
    55                          RESIDX		equ	054h
    56                          RS232DTR	equ	055h
    57                          SETIDX		equ	056h
    58                          CMDSIO		equ	057h				;0 = CMD, 1 = SIOOUT
    59                          
    60                          RS232		equ	050h
    61                          SIOIN		equ	070h
    62                          
    63                          TC0		equ	080h
    64                          TC1		equ	081h
    65                          TC2		equ	082h
    66                          TC3		equ	083h
    67                          
    68                          DDEVIC		equ	0c2fbh
    69                          DCOMND		equ	0c2fch
    70                          DAUX1		equ	0c2fdh
    71                          DAUX2		equ	0c2feh
    72                          DCHECK		equ	0c2ffh
    73                          
    74                          PERCOMBLOCKS	equ	0ff56h
    75                          
SALLY-F000.asm:
    40                          
    41                          ;--------------------------------------------------
    42                          ; Sally code starts here
    43                          ;--------------------------------------------------
    44                               		ORG	0f000h
    45                          
    46                          ;--------------------------------------------------
    47                          ; Firmware jumptable
    48                          ;--------------------------------------------------
    49   000000 c31b00          jmpboot:	jp	boot				;wboot?			f000
    50   000003 c3de03          jmpSallyMon:	jp	sallymon        		;Sally Monitor		f003
    51   000006 c33506          jmpCONST:	jp	const	          		;const			f006
    52   000009 c34006          jmpCONIN:	jp	conin	          		;conin 0f640h		f009
    53   00000c c35006          jmpCONOUT:	jp	conout          		;conout 0f650h		f00c
    54   00000f c32200               		jp	readsector          		;readsector		f00f
    55   000012 c3dcf4               		jp	0f4dch          		;punch			f012
    56   000015 c3ebf4               		jp	0f4ebh          		;reader			f015
    57   000018 c315f6               		jp	0f615h          		;home?		ATARI mode = f7e1 = return
    58                          
    59                          ;--------------------------------------------------
    60                          ; boot
    61                          ;--------------------------------------------------
    62   00001b f3              boot:     	di					;int off
    63   00001c af                  		xor	a				;ROM enable
    64   00001d d352                		out	(ROMSWITCH), a
    65   00001f c30000               		jp	0000h				;jump to ROM
    66                          
    67                          ;--------------------------------------------------
    68                          ; readsector
    69                          ;--------------------------------------------------
    70   000022 cdcb03          readsector:	call	resettc3			;reset TC3
    71   000025 dd7e00               		ld	a, (ix+00h)			;ix = control block
    72   000028 b7                   		or	a				;is zero? percom?
    73   000029 284d                 		jr	z, f078				;yes, jump
    74   00002b 0688                 		ld	b, 88h
    75   00002d 3d                   		dec	a				;is 1?
    76   00002e 287b                 		jr	z, f0ab				;yes
    77   000030 06a8                 		ld	b, 0a8h
    78   000032 3d                   		dec	a				;is 2
    79   000033 2876                 		jr	z, f0ab		; (+76h)
    80   000035 3d                   		dec	a
    81   000036 285f                 		jr	z, f097		; (+5fh)	;is 3
    82   000038 dd3608ff             		ld	(ix+08h), 0ffh
    83                          
    84   00003c f3              readsector1:	di
    85   00003d 3ea7                 		ld	a, 0a7h
    86   00003f d383                 		out	(TC3), a
    87   000041 af                   		xor	a
    88   000042 d383                 		out	(TC3), a
    89   000044 3d                   		dec	a
    90   000045 32c9ff               		ld	(0ffc9h), a
    91   000048 2150f0               		ld	hl, 0f050h
    92   00004b 2216ff               		ld	(0ff16h), hl			;TC3 Int
    93   00004e fb                   		ei
    94   00004f c9                   		ret
    95                          
    96   000050 f5                   		push	af
    97   000051 3ac9ff               		ld	a, (0ffc9h)
    98   000054 3d                   		dec	a
    99   000055 32c9ff               		ld	(0ffc9h), a
   100   000058 200a                 		jr	nz, f064		; (+0ah)
   101   00005a cd68f0               		call	0f068h
   102   00005d 3e21                 		ld	a, 21h
   103   00005f d383                 		out	(TC3), a
   104   000061 322eff               		ld	(0ff2eh), a
   105   000064 f1              f064:		pop	af
   106   000065 fb                   		ei
   107   000066 ed4d                 		reti
   108                          
   109   000068 db41                 		in	a, (FDCTRK)
   110   00006a d343                 		out	(FDCDAT), a
   111   00006c 3e10                 		ld	a, 10h
   112   00006e d340                 		out	(FDCCMD), a
   113                          ;		nop
   114                          ;		nop
   115                          ;		nop
   116                          ;		nop
   117                          ;		nop
   118                          ;		nop
   119                          ;		nop
   120                          ;		nop
   121                          
   122   000070 3a2fff               		ld	a, (0ff2fh)
   123   000073 e6f0                 		and	0f0h
   124   000075 d330                 		out	(DISKCTRL), a
   125   000077 c9                   		ret
   126                          
   127   000078 cd1af1          f078:		call	0f11ah
   128   00007b cb7f                 		bit	7, a
   129   00007d 2805                 		jr	z, f084		; (+05h)
   130   00007f 2130ff               		ld	hl, 0ff30h
   131   000082 3600                 		ld	(hl), 00h
   132   000084 dd7708          f084:		ld	(ix+08h), a
   133   000087 3a2fff               		ld	a, (0ff2fh)
   134   00008a dd7706               		ld	(ix+06h), a
   135   00008d 3a30ff               		ld	a, (0ff30h)
   136   000090 dd7707               		ld	(ix+07h), a
   137   000093 cd3c00               		call	readsector1
   138   000096 c9                   		ret
   139                          
   140   000097 dd360606        f097:		ld	(ix+06h), 06h
   141   00009b dd360700             		ld	(ix+07h), 00h
   142   00009f 06c0                 		ld	b, 0c0h
   143   0000a1 cdb3f0               		call	0f0b3h
   144   0000a4 3a2fff               		ld	a, (0ff2fh)
   145   0000a7 dd7706               		ld	(ix+06h), a
   146   0000aa c9                   		ret
   147                          
   148   0000ab ddcb017e        f0ab:		bit	7, (ix+01h)
   149   0000af 2802                 		jr	z, f0b3		; (+02h)
   150   0000b1 cbc8                 		set	1, b
   151                          ;		nop
   152                          ;		nop
   153   0000b3 78              f0b3:		ld	a, b
   154   0000b4 32c5ff               		ld	(0ffc5h), a
   155   0000b7 cd1af1               		call	0f11ah
   156   0000ba cb7f                 		bit	7, a
   157   0000bc 2852                 		jr	z, f110		; (+52h)	<===== motor on!
   158   0000be 3a2dff               		ld	a, (0ff2dh)
   159   0000c1 feff                 		cp	0ffh
   160   0000c3 2805                 		jr	z, f0ca		; (+05h)
   161   0000c5 ddbe02               		cp	(ix+02h)
   162   0000c8 2805                 		jr	z, f0cf		; (+05h)
   163   0000ca cdf8f1          f0ca:		call	0f1f8h
   164   0000cd 2041                 		jr	nz, f110		; (+41h)
   165   0000cf 3a12ff          f0cf:		ld	a, (TC1INTVEC)
   166   0000d2 3c                   		inc	a
   167   0000d3 20fa                 		jr	nz, f0cf		; (-06h)
   168   0000d5 f3                   		di
   169   0000d6 3e03                 		ld	a, 03h
   170   0000d8 d380                 		out	(TC0), a
   171   0000da 3e27                 		ld	a, 27h
   172   0000dc d382                 		out	(82h), a
   173   0000de 3e3d                 		ld	a, 3dh
   174   0000e0 d382                 		out	(82h), a
   175   0000e2 21a8f3               		ld	hl, 0f3a8h
   176   0000e5 2216ff               		ld	(0ff16h), hl
   177   0000e8 3a33ff               		ld	a, (0ff33h)
   178   0000eb 32c6ff               		ld	(0ffc6h), a
   179   0000ee dd7e03          f0ee:		ld	a, (ix+03h)
   180   0000f1 d342                 		out	(FDCSEC), a
   181   0000f3 dd7e02               		ld	a, (ix+02h)
   182   0000f6 d341                 		out	(FDCTRK), a
   183   0000f8 3ac5ff               		ld	a, (0ffc5h)
   184   0000fb d340                 		out	(FDCCMD), a
   185   0000fd cdb5f2               		call	0f2b5h
   186   000100 280e                 		jr	z, f110		; (+0eh)
   187   000102 f5                   		push	af
   188   000103 cd0ef3               		call	0f30eh
   189   000106 c1                   		pop	bc
   190   000107 2006                 		jr	nz, f10f		; (+06h)
   191   000109 21c6ff               		ld	hl, 0ffc6h
   192   00010c 35                   		dec	(hl)
   193   00010d 20df                 		jr	nz, f0ee		; (-21h)
   194   00010f 78              f10f:		ld	a, b
   195   000110 dd7708          f110:		ld	(ix+08h), a
   196   000113 cd18f0               		call	0f018h
   197   000116 cd3c00               		call	readsector1
   198   000119 c9                   		ret
   199                          
   200   00011a dd7e01               		ld	a, (ix+01h)
   201   00011d cbbf                 		res	7, a
   202   00011f fe04                 		cp	04h
   203   000121 306b                 		jr	nc, f18e		; (+6bh)
   204   000123 0600                 		ld	b, 00h
   205   000125 4f                   		ld	c, a
   206   000126 212cff               		ld	hl, 0ff2ch
   207   000129 96                   		sub	(hl)
   208   00012a f5                   		push	af
   209   00012b 50                   		ld	d, b
   210   00012c 5e                   		ld	e, (hl)
   211   00012d 71                   		ld	(hl), c
   212   00012e 2120ff               		ld	hl, 0ff20h
   213   000131 19                   		add	hl, de
   214   000132 3a2dff               		ld	a, (0ff2dh)
   215   000135 77                   		ld	(hl), a
   216   000136 1e04                 		ld	e, 04h
   217   000138 19                   		add	hl, de
   218   000139 3a2fff               		ld	a, (0ff2fh)
   219   00013c 77                   		ld	(hl), a
   220   00013d 2120ff               		ld	hl, 0ff20h
   221   000140 09                   		add	hl, bc
   222   000141 7e                   		ld	a, (hl)
   223   000142 322dff               		ld	(0ff2dh), a
   224   000145 19                   		add	hl, de
   225   000146 d1                   		pop	de
   226   000147 7e                   		ld	a, (hl)
   227   000148 b7                   		or	a
   228   000149 201f                 		jr	nz, f16a		; (+1fh)
   229   00014b 2198f1               		ld	hl, 0f198h
   230   00014e 09                   		add	hl, bc
   231   00014f 7e                   		ld	a, (hl)
   232   000150 d330                 		out	(DISKCTRL), a
   233   000152 f5                   		push	af
   234   000153 cd9cf1               		call	0f19ch
   235   000156 c1                   		pop	bc
   236   000157 fede                 		cp	0deh
   237   000159 3033                 		jr	nc, f18e		; (+33h)
   238   00015b cbf0                 		set	6, b
   239   00015d feb5                 		cp	0b5h
   240   00015f 3006                 		jr	nc, f167		; (+06h)
   241   000161 cbb0                 		res	6, b
   242   000163 fe99                 		cp	99h
   243   000165 3827                 		jr	c, f18e		; (+27h)
   244   000167 78              f167:		ld	a, b
   245   000168 1600                 		ld	d, 00h
   246   00016a cbaf            f16a:		res	5, a
   247   00016c ddcb017e             		bit	7, (ix+01h)
   248   000170 2802                 		jr	z, f174		; (+02h)
   249   000172 cbef                 		set	5, a
   250   000174 d330            f174:		out	(DISKCTRL), a
   251   000176 322fff               		ld	(0ff2fh), a
   252   000179 14                   		inc	d
   253   00017a 15                   		dec	d
   254   00017b c499f3               		call	nz, 0f399h
   255   00017e cd91f3               		call	0f391h
   256   000181 cb6f                 		bit	5, a
   257   000183 c0                   		ret	nz
   258                          
   259   000184 cd9cf1               		call	0f19ch
   260   000187 b7                   		or	a				;clear carry
   261   000188 2804            f188:     	jr	z, f18e				;jr	c, xxh
   262   00018a cd91f3               		call	0f391h				;if ATARI mode never executed
   263   00018d c9                   		ret
   264                          
   265   00018e af              f18e:		xor	a
   266   00018f d330                 		out	(DISKCTRL), a
   267   000191 322fff               		ld	(0ff2fh), a
   268   000194 3e80                 		ld	a, 80h
   269   000196 b7                   		or	a
   270   000197 c9                   		ret
   271                          
   272   000198 010204               		ld	bc, 0402h
   273   00019b 08                   		ex	af, af'
   274   00019c af                   		xor	a
   275   00019d d356                 		out	(SETIDX), a
   276   00019f 3c                   		inc	a
   277   0001a0 d354                 		out	(RESIDX), a
   278   0001a2 db41                 		in	a, (FDCTRK)
   279   0001a4 d343                 		out	(FDCDAT), a
   280   0001a6 3e18                 		ld	a, 18h
   281   0001a8 d340                 		out	(FDCCMD), a
   282   0001aa cdbaf3               		call	0f3bah
   283   0001ad cd91f3               		call	0f391h
   284   0001b0 4f                   		ld	c, a
   285   0001b1 0606                 		ld	b, 06h
   286   0001b3 210000               		ld	hl, 0000h
   287   0001b6 22c7ff               		ld	(0ffc7h), hl
   288   0001b9 ed5bc7ff        f1b9:		ld	de, (0ffc7h)
   289   0001bd cde3f1               		call	0f1e3h
   290   0001c0 380d                 		jr	c, f1cf		; (+0dh)
   291   0001c2 cde3f1               		call	0f1e3h
   292   0001c5 3808                 		jr	c, f1cf		; (+08h)
   293   0001c7 10f0                 		djnz	f1b9		; (-10h)
   294   0001c9 2ac7ff               		ld	hl, (0ffc7h)
   295   0001cc b7                   		or	a
   296   0001cd ed52                 		sbc	hl, de
   297   0001cf cdcbf3          f1cf:		call	0f3cbh
   298   0001d2 af                   		xor	a
   299   0001d3 d354                 		out	(RESIDX), a
   300   0001d5 3c                   		inc	a
   301   0001d6 d356                 		out	(SETIDX), a
   302   0001d8 7d                   		ld	a, l
   303   0001d9 24                   		inc	h
   304   0001da 25                   		dec	h
   305   0001db 2802                 		jr	z, f1df		; (+02h)
   306   0001dd 3eff                 		ld	a, 0ffh
   307   0001df 3230ff          f1df:		ld	(0ff30h), a
   308   0001e2 c9                   		ret
   309                          
   310   0001e3 cd91f3          f1e3:		call	0f391h
   311   0001e6 a9                   		xor	c
   312   0001e7 e602                 		and	02h
   313   0001e9 2009                 		jr	nz, f1f4		; (+09h)
   314   0001eb 3ac8ff               		ld	a, (0ffc8h)
   315   0001ee fe08                 		cp	08h
   316   0001f0 38f1                 		jr	c, f1e3		; (-0fh)
   317   0001f2 37                   		scf
   318   0001f3 c9                   		ret
   319                          
   320   0001f4 79              f1f4:		ld	a, c
   321   0001f5 2f                   		cpl
   322   0001f6 4f                   		ld	c, a
   323   0001f7 c9                   		ret
   324                          
   325   0001f8 3a2dff               		ld	a, (0ff2dh)
   326   0001fb feff                 		cp	0ffh
   327   0001fd 2005                 		jr	nz, f204		; (+05h)
   328   0001ff cd37f2               		call	0f237h
   329   000202 202a                 		jr	nz, f22e		; (+2ah)
   330   000204 0601            f204:		ld	b, 01h
   331   000206 cd57f2               		call	0f257h
   332   000209 c8                   		ret	z
   333                          
   334   00020a 3005                 		jr	nc, f211		; (+05h)
   335   00020c cd37f2               		call	0f237h
   336   00020f 201d                 		jr	nz, f22e		; (+1dh)
   337   000211 0602            f211:		ld	b, 02h
   338   000213 cd57f2               		call	0f257h
   339   000216 c8                   		ret	z
   340                          
   341   000217 3815                 		jr	c, f22e		; (+15h)
   342   000219 216400               		ld	hl, 0064h
   343   00021c cd9ef3               		call	0f39eh
   344   00021f 2128ff               		ld	hl, 0ff28h
   345   000222 3a2cff               		ld	a, (0ff2ch)
   346   000225 85                   		add	a, l
   347   000226 6f                   		ld	l, a
   348   000227 34                   		inc	(hl)
   349   000228 7e                   		ld	a, (hl)
   350   000229 e603                 		and	03h
   351   00022b 20e4                 		jr	nz, f211		; (-1ch)
   352   00022d 35                   		dec	(hl)
   353   00022e 3eff            f22e:		ld	a, 0ffh
   354   000230 322dff               		ld	(0ff2dh), a
   355   000233 3e10                 		ld	a, 10h
   356   000235 b7                   		or	a
   357   000236 c9                   		ret
   358                          
   359   000237 3a2fff               		ld	a, (0ff2fh)
   360   00023a cbe7                 		set	4, a
   361   00023c d330                 		out	(DISKCTRL), a
   362   00023e 060f                 		ld	b, 0fh
   363   000240 10fe            f240:		djnz	f240		; (-02h)
   364   000242 cba7                 		res	4, a
   365   000244 d330                 		out	(DISKCTRL), a
   366   000246 0600                 		ld	b, 00h
   367   000248 10fe            f248:		djnz	f248		; (-02h)
   368   00024a cd91f3               		call	0f391h
   369   00024d 3e0b                 		ld	a, 0bh
   370   00024f cd6bf3               		call	0f36bh
   371   000252 ee04                 		xor	04h
   372   000254 e604                 		and	04h
   373   000256 c9                   		ret
   374                          
   375   000257 c5              f257:		push	bc
   376   000258 3a2dff               		ld	a, (0ff2dh)
   377   00025b 47                   		ld	b, a
   378   00025c dd4e02               		ld	c, (ix+02h)
   379   00025f cd75f2               		call	0f275h
   380   000262 cd95f2               		call	0f295h
   381   000265 c1                   		pop	bc
   382   000266 37                   		scf
   383   000267 c0                   		ret	nz
   384                          
   385   000268 db42                 		in	a, (FDCSEC)
   386   00026a 322dff               		ld	(0ff2dh), a
   387   00026d dd9602               		sub	(ix+02h)
   388   000270 c8                   		ret	z
   389                          
   390   000271 10e4                 		djnz	f257		; (-1ch)
   391   000273 b7                   		or	a
   392   000274 c9                   		ret
   393                          
   394   000275 78                   		ld	a, b
   395   000276 d341                 		out	(FDCTRK), a
   396   000278 79                   		ld	a, c
   397   000279 d343                 		out	(FDCDAT), a
   398   00027b 2128ff               		ld	hl, 0ff28h
   399   00027e 3a2cff               		ld	a, (0ff2ch)
   400   000281 85                   		add	a, l
   401   000282 6f                   		ld	l, a
   402   000283 7e                   		ld	a, (hl)
   403   000284 e603                 		and	03h
   404   000286 f618                 		or	18h
   405   000288 cd6bf3               		call	0f36bh
   406   00028b 7e                   		ld	a, (hl)
   407   00028c e6fc                 		and	0fch
   408   00028e 2600                 		ld	h, 00h
   409   000290 6f                   		ld	l, a
   410   000291 cd9ef3               		call	0f39eh
   411   000294 c9                   		ret
   412                          
   413   000295 3ec0            verify:     	ld	a, 0c0h
   414   000297 cd62f3               		call	0f362h
   415   00029a e618                 		and	18h
   416   00029c c8                   		ret	z
   417                          
   418   00029d 3a2fff               		ld	a, (0ff2fh)
   419   0002a0 ee80                 		xor	80h
   420   0002a2 322fff               		ld	(0ff2fh), a
   421   0002a5 d330                 		out	(DISKCTRL), a
   422   0002a7 213200               		ld	hl, 0032h
   423   0002aa cd9ef3               		call	0f39eh
   424   0002ad 3ec0                 		ld	a, 0c0h
   425   0002af cd62f3               		call	0f362h
   426   0002b2 e618                 		and	18h
   427   0002b4 c9                   		ret
   428                          
   429   0002b5 2a6600               		ld	hl, (0066h)
   430   0002b8 e5                   		push	hl
   431   0002b9 2a6800               		ld	hl, (0068h)
   432   0002bc e5                   		push	hl
   433   0002bd 21eda2               		ld	hl, 0a2edh
   434   0002c0 cb6f                 		bit	5, a
   435   0002c2 2801                 		jr	z, f2c5		; (+01h)
   436   0002c4 24                   		inc	h
   437   0002c5 226600          f2c5:		ld	(0066h), hl
   438   0002c8 216800               		ld	hl, 0068h
   439   0002cb 36c9                 		ld	(hl), 0c9h
   440   0002cd f3                   		di
   441   0002ce 3ec7                 		ld	a, 0c7h
   442   0002d0 d383                 		out	(TC3), a
   443   0002d2 af                   		xor	a
   444   0002d3 d383                 		out	(TC3), a
   445   0002d5 fb                   		ei
   446   0002d6 dd6e04               		ld	l, (ix+04h)
   447   0002d9 dd6605               		ld	h, (ix+05h)
   448   0002dc dd4606               		ld	b, (ix+06h)
   449   0002df 0e43                 		ld	c, 43h
   450   0002e1 dd7e07               		ld	a, (ix+07h)
   451   0002e4 cb3f                 		srl	a
   452   0002e6 280d                 		jr	z, f2f5		; (+0dh)
   453   0002e8 cb3f                 		srl	a
   454   0002ea 2806                 		jr	z, f2f2		; (+06h)
   455   0002ec 76              f2ec:		halt
   456   0002ed 20fd                 		jr	nz, f2ec		; (-03h)
   457   0002ef 76              f2ef:		halt
   458   0002f0 20fd                 		jr	nz, f2ef		; (-03h)
   459   0002f2 76              f2f2:		halt
   460   0002f3 20fd                 		jr	nz, f2f2		; (-03h)
   461   0002f5 76              f2f5:		halt
   462   0002f6 20fd                 		jr	nz, f2f5		; (-03h)
   463   0002f8 db40            f2f8:		in	a, (FDCSTAT)
   464   0002fa cb47                 		bit	0, a
   465   0002fc 20fa                 		jr	nz, f2f8		; (-06h)
   466   0002fe 47                   		ld	b, a
   467   0002ff cdcbf3               		call	0f3cbh
   468   000302 78                   		ld	a, b
   469   000303 e1                   		pop	hl
   470   000304 226800               		ld	(0068h), hl
   471   000307 e1                   		pop	hl
   472   000308 226600               		ld	(0066h), hl
   473   00030b e67d                 		and	07dh
   474   00030d c9                   		ret
   475                          
   476   00030e 47                   		ld	b, a
   477   00030f e6e7                 		and	0e7h
   478   000311 2808                 		jr	z, f31b		; (+08h)
   479   000313 f5                   		push	af
   480   000314 cd91f3               		call	0f391h
   481   000317 f1                   		pop	af
   482   000318 e6e1                 		and	0e1h
   483   00031a c9                   		ret
   484                          
   485   00031b cb60            f31b:		bit	4, b
   486   00031d 2023                 		jr	nz, f342		; (+23h)
   487   00031f 3a33ff               		ld	a, (0ff33h)
   488   000322 21c6ff               		ld	hl, 0ffc6h
   489   000325 96                   		sub	(hl)
   490   000326 c8                   		ret	z
   491                          
   492   000327 3a2dff               		ld	a, (0ff2dh)
   493   00032a 47                   		ld	b, a
   494   00032b b7                   		or	a
   495   00032c 2004                 		jr	nz, f332		; (+04h)
   496   00032e 0e01                 		ld	c, 01h
   497   000330 1802                 		jr	f334		; (+02h)
   498   000332 3d              f332:		dec	a
   499   000333 4f                   		ld	c, a
   500   000334 c5              f334:		push	bc
   501   000335 cd75f2               		call	0f275h
   502   000338 d1                   		pop	de
   503   000339 43                   		ld	b, e
   504   00033a 4a                   		ld	c, d
   505   00033b cd75f2               		call	0f275h
   506   00033e cd95f2               		call	0f295h
   507   000341 c9                   		ret
   508                          
   509   000342 cd95f2          f342:		call	0f295h
   510   000345 2012                 		jr	nz, f359		; (+12h)
   511   000347 db42                 		in	a, (FDCSEC)
   512   000349 ddbe02               		cp	(ix+02h)
   513   00034c 200d                 		jr	nz, f35b		; (+0dh)
   514   00034e 3a33ff               		ld	a, (0ff33h)
   515   000351 21c6ff               		ld	hl, 0ffc6h
   516   000354 96                   		sub	(hl)
   517   000355 c8                   		ret	z
   518                          
   519   000356 3e10                 		ld	a, 10h
   520   000358 c9                   		ret
   521                          
   522   000359 3eff            f359:		ld	a, 0ffh
   523   00035b 322dff          f35b:		ld	(0ff2dh), a
   524   00035e cdf8f1               		call	0f1f8h
   525   000361 c9                   		ret
   526                          
   527   000362 cd89f3               		call	0f389h
   528   000365 c5                   		push	bc
   529   000366 016a18               		ld	bc, 186ah
   530   000369 1807                 		jr	f372		; (+07h)
   531   00036b cd89f3               		call	0f389h
   532   00036e c5                   		push	bc
   533   00036f 017c92               		ld	bc, 927ch
   534   000372 db40            f372:		in	a, (FDCSTAT)
   535   000374 cb47                 		bit	0, a
   536   000376 280a                 		jr	z, f382		; (+0ah)
   537   000378 cd8bf3               		call	0f38bh
   538   00037b 0b                   		dec	bc
   539   00037c 78                   		ld	a, b
   540   00037d b1                   		or	c
   541   00037e 20f2                 		jr	nz, f372		; (-0eh)
   542   000380 3e10                 		ld	a, 10h
   543   000382 47              f382:		ld	b, a
   544   000383 cd91f3               		call	0f391h
   545   000386 78                   		ld	a, b
   546   000387 c1                   		pop	bc
   547   000388 c9                   		ret
   548                          
   549   000389 d340                 		out	(FDCCMD), a
   550   00038b 3e0e                 		ld	a, 0eh
   551   00038d 3d              f38d:		dec	a
   552   00038e 20fd                 		jr	nz, f38d		; (-03h)
   553   000390 c9                   		ret
   554                          
   555   000391 3ed0                 		ld	a, 0d0h
   556   000393 cd89f3               		call	0f389h
   557   000396 db40                 		in	a, (FDCSTAT)
   558   000398 c9                   		ret
   559                          
   560   000399 2a32ff               		ld	hl, (0ff32h)
   561   00039c 2600                 		ld	h, 00h
   562   00039e af              f39e:		xor	a
   563   00039f 3d              f39f:		dec	a
   564   0003a0 20fd                 		jr	nz, f39f		; (-03h)
   565   0003a2 2b                   		dec	hl
   566   0003a3 7c                   		ld	a, h
   567   0003a4 b5                   		or	l
   568   0003a5 20f7                 		jr	nz, f39e		; (-09h)
   569   0003a7 c9                   		ret
   570                          
   571   0003a8 3ed0                 		ld	a, 0d0h
   572   0003aa d340                 		out	(FDCCMD), a
   573   0003ac 3e01                 		ld	a, 01h
   574   0003ae d383                 		out	(TC3), a
   575   0003b0 2103f3               		ld	hl, 0f303h
   576   0003b3 e3                   		ex	(sp), hl
   577   0003b4 3e10                 		ld	a, 10h
   578   0003b6 b7                   		or	a
   579   0003b7 fb                   		ei
   580   0003b8 ed4d                 		reti
   581                          
   582   0003ba f3                   		di
   583   0003bb 3e87                 		ld	a, 87h
   584   0003bd d383                 		out	(TC3), a
   585   0003bf 3efa                 		ld	a, 0fah
   586   0003c1 d383                 		out	(TC3), a
   587   0003c3 21d2f3               		ld	hl, 0f3d2h
   588   0003c6 2216ff               		ld	(0ff16h), hl
   589   0003c9 fb                   		ei
   590   0003ca c9                   		ret
   591                          
   592   0003cb f3              resettc3:     	di
   593   0003cc 3e01                 		ld	a, 01h
   594   0003ce d383                 		out	(TC3), a
   595   0003d0 fb                   		ei
   596   0003d1 c9                   		ret
   597                          
   598   0003d2 e5                   		push	hl
   599   0003d3 fb                   		ei
   600   0003d4 2ac7ff               		ld	hl, (0ffc7h)
   601   0003d7 23                   		inc	hl
   602   0003d8 22c7ff               		ld	(0ffc7h), hl
   603   0003db e1                   		pop	hl
   604   0003dc ed4d                 		reti
   605                          
   606                          ;--------------------------------------------------
   607                          ; SALLY Monitor
   608                          ;--------------------------------------------------
   609                          ;f3de
   610   0003de 3e01            sallymon:     	ld	a, 01h
   611   0003e0 d352                 		out	(ROMSWITCH), a			;turn off ROM
   612   0003e2 cdfc05               		call	init9600			;init send/receive at 9600 baud (T/C 0 interrupt)
   613   0003e5 cdc904               		call	printstr
   614   0003e8 0d0a526f6c6c6931		db	"\r\n",  "Rolli1",  0
                00              
   615                          
   616   0003f1 21f103          monloop:	ld	hl,  monloop			;loop here
   617   0003f4 e5                   		push	hl
   618   0003f5 cdc904               		call	printstr
   619   0003f8 0d0a232000      		db	"\r\n# ",  0
   620                          
   621   0003fd cdb204          f3fd:		call	getchar				;read from conin
   622   000400 fe20                 		cp	20h				;< 20h = control-character?
   623   000402 d8                   		ret	c				;yes, return monloop
   624                          
   625   000403 4f                   		ld	c, a				;save a
   626   000404 af                   		xor	a				;a = 0
   627   000405 67                   		ld	h, a				;hl = 0
   628   000406 6f                   		ld	l, a
   629   000407 29              f407:		add	hl, hl
   630   000408 29                   		add	hl, hl
   631   000409 29                   		add	hl, hl
   632   00040a 29                   		add	hl, hl
   633   00040b b5                   		or	l
   634   00040c 6f                   		ld	l, a
   635   00040d cdb204               		call	getchar
   636   000410 fe0d                 		cp	0dh				;CR?
   637   000412 280c                 		jr	z, f420				;yes
   638   000414 cd8304               		call	checkchar
   639   000417 30ee                 		jr	nc, f407
   640   000419 cdc904          f419:		call	printstr
   641   00041c 203f00          		db	" ?",  0
   642   00041f c9                   		ret
   643                          
   644   000420 cdd504          f420:		call	newline
   645   000423 79                   		ld	a, c
   646   000424 fe47                 		cp	47h
   647   000426 2836                 		jr	z, f45e		; (+36h)
   648   000428 fe42                 		cp	42h
   649   00042a 2833                 		jr	z, f45f		; (+33h)
   650   00042c fe4d                 		cp	4dh
   651   00042e 20e9                 		jr	nz, f419		; (-17h)
   652   000430 cd93f4          f430:		call	0f493h
   653   000433 7e                   		ld	a, (hl)
   654   000434 cd98f4               		call	0f498h
   655   000437 cdb204               		call	getchar
   656   00043a fe0d                 		cp	0dh
   657   00043c 2818                 		jr	z, f456		; (+18h)
   658   00043e fe2d                 		cp	2dh
   659   000440 2816                 		jr	z, f458		; (+16h)
   660   000442 cd83f4               		call	0f483h
   661   000445 3f                   		ccf
   662   000446 d0                   		ret	nc
   663                          
   664   000447 07                   		rlca
   665   000448 07                   		rlca
   666   000449 07                   		rlca
   667   00044a 07                   		rlca
   668   00044b 4f                   		ld	c, a
   669   00044c cdb204               		call	getchar
   670   00044f cd83f4               		call	0f483h
   671   000452 3f                   		ccf
   672   000453 d0                   		ret	nc
   673                          
   674   000454 b1                   		or	c
   675   000455 77                   		ld	(hl), a
   676   000456 23              f456:		inc	hl
   677   000457 23                   		inc	hl
   678   000458 2b              f458:		dec	hl
   679   000459 cdd504               		call	newline
   680   00045c 18d2                 		jr	f430		; (-2eh)
   681   00045e e9              f45e:		jp	(hl)
   682   00045f dd217af4        f45f:		ld	ix, 0f47ah
   683   000463 cd2200               		call	readsector
   684   000466 dd7e08               		ld	a, (ix+08h)
   685   000469 b7                   		or	a
   686   00046a cc8000               		call	z, 0080h
   687   00046d f5                   		push	af
   688   00046e cdc904               		call	printstr
   689   000471 2045                 		jr	nz, f4b8		; (+45h)
   690   000473 52                   		ld	d, d
   691   000474 52                   		ld	d, d
   692   000475 2000                 		jr	nz, f477		; (+00h)
   693   000477 f1              f477:		pop	af
   694   000478 1825                 		jr	puthex		; (+25h)
   695   00047a 010000               		ld	bc, 0000h
   696   00047d 018000               		ld	bc, 0080h
   697   000480 80                   		add	a, b
   698   000481 00                   		nop
   699   000482 00                   		nop
   700                          
   701                          checkchar:
   702   000483 d630                 		sub	30h			;<0 ?
   703   000485 d8                   		ret	c			;yes, return
   704                          
   705   000486 fe0a                 		cp	0ah			;<10?
   706   000488 3f                   		ccf
   707   000489 d0                   		ret	nc
   708                          
   709   00048a d607                 		sub	07h			;sub 8, carry set
   710   00048c fe0a                 		cp	0ah
   711   00048e d8                   		ret	c
   712                          
   713   00048f fe10                 		cp	10h			;<16
   714   000491 3f                   		ccf
   715   000492 c9                   		ret				;carry set if >= 16
   716                          
   717   000493 7c                   		ld	a, h
   718   000494 cd9f04               		call	puthex
   719   000497 7d                   		ld	a, l
   720   000498 cd9f04               		call	puthex
   721   00049b 3e20                 		ld	a, 20h
   722   00049d 181f                 		jr	putchar		; (+1fh)
   723                          
   724   00049f f5              puthex:		push	af
   725   0004a0 1f                   		rra
   726   0004a1 1f                   		rra
   727   0004a2 1f                   		rra
   728   0004a3 1f                   		rra
   729   0004a4 cda804               		call	putnibble
   730   0004a7 f1              		pop	af
   731   0004a8 e60f            putnibble:	and	0fh
   732   0004aa c690                 		add	a, 90h
   733   0004ac 27                   		daa
   734   0004ad ce40                 		adc	a, 40h
   735   0004af 27                   		daa
   736   0004b0 180c                 		jr	putchar		; (+0ch)
   737                          
   738   0004b2 e5              getchar:     	push	hl
   739   0004b3 c5                   		push	bc
   740   0004b4 cd0900               		call	jmpCONIN			;CONIN in jumptable
   741   0004b7 c1                   		pop	bc
   742   0004b8 e1              f4b8:		pop	hl
   743   0004b9 cbbf                 		res	7, a				;reset parity bit
   744   0004bb fe20                 		cp	20h				;char < 20h = control char?
   745   0004bd d8                   		ret	c				;yes, return
   746                          
   747   0004be e5              putchar:	push	hl				;echo CONOUT
   748   0004bf c5                   		push	bc
   749   0004c0 f5                   		push	af
   750   0004c1 4f                   		ld	c, a
   751   0004c2 cd0c00               		call	jmpCONOUT
   752   0004c5 f1                   		pop	af
   753   0004c6 c1                   		pop	bc
   754   0004c7 e1                   		pop	hl
   755   0004c8 c9                   		ret
   756                          
   757   0004c9 e3              printstr:    	ex	(sp), hl			;exchange (load) hl with stackpointer
   758   0004ca 7e              printstr1:	ld	a, (hl)				;load char
   759   0004cb cdbe04               		call	putchar				;print it
   760   0004ce 7e                   		ld	a, (hl)				;load it again
   761   0004cf 23                   		inc	hl				;increment hl
   762   0004d0 b7                   		or	a				;char <> 0?
   763   0004d1 20f7                 		jr	nz, printstr1			;loop
   764   0004d3 e3                   		ex	(sp), hl			;write hl back to stack
   765   0004d4 c9                   		ret
   766                          
   767   0004d5 cdc904          newline:     	call	printstr
   768   0004d8 0d0a00          		db	"\r\n", 0
   769   0004db c9                   		ret
   770                          
   771   0004dc 79                   		ld	a, c
   772   0004dd d320                 		out	(20h), a
   773   0004df e3                   		ex	(sp), hl
   774   0004e0 e3                   		ex	(sp), hl
   775   0004e1 3e19                 		ld	a, 19h
   776   0004e3 d353                 		out	(STROBE), a
   777   0004e5 3d              f4e5:		dec	a
   778   0004e6 20fd                 		jr	nz, f4e5		; (-03h)
   779   0004e8 d353                 		out	(STROBE), a
   780   0004ea c9                   		ret
   781                          
   782   0004eb 2a47ff          f4eb:     	ld	hl, (0ff47h)
   783   0004ee db20                 		in	a, (20h)			;printer control
   784   0004f0 a5                   		and	l
   785   0004f1 ac                   		xor	h
   786   0004f2 c9                   		ret
   787                          
   788   0004f3 95                   		sub	l
   789   0004f4 00                   		nop
   790   0004f5 00                   		nop
   791   0004f6 00                   		nop
   792   0004f7 00                   		nop
   793   0004f8 00                   		nop
   794   0004f9 00                   		nop
   795   0004fa 00                   		nop
   796   0004fb 00                   		nop
   797   0004fc 00                   		nop
   798   0004fd 00                   		nop
   799   0004fe 00                   		nop
   800   0004ff 00                   		nop
   801                          
   802                          ;--------------------------------------------------
   803                          ; conin T/C 0 (here counter) interrupt for start-bit
   804                          ;--------------------------------------------------
   805   000500 f5              coninInt:	push	af
   806   000501 3e87                 		ld	a, 87h
   807   000503 d380                 		out	(TC0), a			;set T/C 0 to 9600 Baud timer
   808   000505 3e1a            baud9600:     	ld	a, 1ah
   809   000507 d380                 		out	(TC0), a
   810   000509 3e17                 		ld	a, coninIntB & 255		;set T/C 0 interrupt to next routine
   811   00050b 3210ff               		ld	(TC0INTVEC), a
   812   00050e 3e7f                 		ld	a, 7fh
   813   000510 321c05          coninInt1:	ld	(inbyte + 1), a
   814   000513 f1                   		pop	af
   815   000514 fb                   		ei
   816   000515 ed4d                 		reti
   817                          
   818   000517 f5              coninIntB:    	push	af
   819   000518 db70                 		in	a, (SIOIN)
   820   00051a 17                   		rla
   821   00051b 3e00            inbyte:    	ld	a, 00h				;<- set by previous routine to 7fh
   822   00051d 1f                   		rra
   823   00051e 38f0                 		jr	c, coninInt1			;loop 7 times
   824   000520 3200ff          coninIntPtr:    ld	(0ff00h), a			;store result in ff00
   825   000523 3e2c                 		ld	a, coninIntC & 255		;timer 0 interrupt vector = 0ff2c
   826   000525 3210ff          		ld	(TC0INTVEC), a
   827   000528 f1                   		pop	af
   828   000529 fb                   		ei
   829   00052a ed4d                 		reti
   830                          
   831   00052c f5              coninIntC:     	push	af
   832   00052d 3ec7                 		ld	a, 0c7h				;timer 0 counter
   833   00052f d380                 		out	(TC0), a
   834   000531 3e01                 		ld	a, 01h
   835   000533 d380                 		out	(TC0), a
   836   000535 3a2105               		ld	a, (coninIntPtr + 1)
   837   000538 3c                   		inc	a
   838   000539 e60f                 		and	0fh
   839   00053b 322105               		ld	(coninIntPtr + 1), a		;increment buffer (16 bytes)
   840   00053e 3e00                 		ld	a, coninInt & 255		;reset T/C 0 interrupt to start-bit routine
   841   000540 3210ff               		ld	(TC0INTVEC), a
   842   000543 f1                   		pop	af
   843   000544 fb                   		ei
   844   000545 ed4d                 		reti
   845                          
   846                          
   847                          ;--------------------------------------------------
   848                          ; conout T/C 1 interrupt for start-bit
   849                          ;--------------------------------------------------
   850   000547 f5              conoutIntA:     push	af
   851   000548 af                   		xor	a
   852   000549 d350                 		out	(SIOOUT), a
   853   00054b 3e54                 		ld	a, conoutIntB & 255
   854   00054d 3212ff               		ld	(TC1INTVEC), a
   855   000550 f1                   		pop	af
   856   000551 fb                   		ei
   857   000552 ed4d                 		reti
   858                          
   859   000554 f5              conoutIntB:	push	af
   860   000555 3e00            		ld	a, 00h
   861   000557 d350                 		out	(SIOOUT), a
   862   000559 1f                   		rra
   863   00055a 326805               		ld	(conoutIntC + 2), a
   864   00055d 3e66                 		ld	a, conoutIntC & 255
   865   00055f 3212ff               		ld	(TC1INTVEC), a
   866   000562 f1                   		pop	af
   867   000563 fb                   		ei
   868   000564 ed4d                 		reti
   869                          
   870   000566 f5              conoutIntC:	push	af
   871   000567 3e00                 		ld	a, 00h
   872   000569 d350                 		out	(SIOOUT), a
   873   00056b 1f                   		rra
   874   00056c 327a05               		ld	(conoutIntD + 2), a
   875   00056f 3e78                 		ld	a, conoutIntD & 255
   876   000571 3212ff               		ld	(TC1INTVEC), a
   877   000574 f1                   		pop	af
   878   000575 fb                   		ei
   879   000576 ed4d                 		reti
   880                          
   881   000578 f5              conoutIntD:	push	af
   882   000579 3e00                 		ld	a, 00h
   883   00057b d350                 		out	(SIOOUT), a
   884   00057d 1f                   		rra
   885   00057e 328c05               		ld	(conoutIntE + 2), a
   886   000581 3e8a                 		ld	a, conoutIntE & 255
   887   000583 3212ff               		ld	(TC1INTVEC), a
   888   000586 f1                   		pop	af
   889   000587 fb                   		ei
   890   000588 ed4d                 		reti
   891                          
   892   00058a f5              conoutIntE:	push	af
   893   00058b 3e00                 		ld	a, 00h
   894   00058d d350                 		out	(SIOOUT), a
   895   00058f 1f                   		rra
   896   000590 329e05               		ld	(conoutIntF + 2), a
   897   000593 3e9c                 		ld	a, conoutIntF & 255
   898   000595 3212ff               		ld	(TC1INTVEC), a
   899   000598 f1                   		pop	af
   900   000599 fb                   		ei
   901   00059a ed4d                 		reti
   902                          
   903   00059c f5              conoutIntF:	push	af
   904   00059d 3e00                 		ld	a, 00h
   905   00059f d350                 		out	(SIOOUT), a
   906   0005a1 1f                   		rra
   907   0005a2 32b005               		ld	(conoutIntG + 2), a
   908   0005a5 3eae                 		ld	a, conoutIntG & 255
   909   0005a7 3212ff               		ld	(TC1INTVEC), a
   910   0005aa f1                   		pop	af
   911   0005ab fb                   		ei
   912   0005ac ed4d                 		reti
   913                          
   914   0005ae f5              conoutIntG:	push	af
   915   0005af 3e00                 		ld	a, 00h
   916   0005b1 d350                 		out	(SIOOUT), a
   917   0005b3 1f                   		rra
   918   0005b4 32c205               		ld	(conoutIntH + 2), a
   919   0005b7 3ec0                 		ld	a, conoutIntH & 255
   920   0005b9 3212ff               		ld	(TC1INTVEC), a
   921   0005bc f1                   		pop	af
   922   0005bd fb                   		ei
   923   0005be ed4d                 		reti
   924                          
   925   0005c0 f5              conoutIntH:	push	af
   926   0005c1 3e00                 		ld	a, 00h
   927   0005c3 d350                 		out	(SIOOUT), a
   928   0005c5 1f                   		rra
   929   0005c6 32d405               		ld	(conoutIntI + 2), a
   930   0005c9 3ed2                 		ld	a, conoutIntI & 255
   931   0005cb 3212ff               		ld	(TC1INTVEC), a
   932   0005ce f1                   		pop	af
   933   0005cf fb                   		ei
   934   0005d0 ed4d                 		reti
   935                          
   936   0005d2 f5              conoutIntI:	push	af
   937   0005d3 3e00                 		ld	a, 00h
   938   0005d5 d350                 		out	(SIOOUT), a
   939   0005d7 3ee0                 		ld	a, conoutIntJ & 255
   940   0005d9 3212ff               		ld	(TC1INTVEC), a
   941   0005dc f1                   		pop	af
   942   0005dd fb                   		ei
   943   0005de ed4d                 		reti
   944                          
   945   0005e0 f5              conoutIntJ:	push	af
   946   0005e1 3e01                 		ld	a, 01h				;stop bit
   947   0005e3 d350                 		out	(SIOOUT), a
   948   0005e5 3eee                 		ld	a, resetConin & 255
   949   0005e7 3212ff               		ld	(TC1INTVEC), a
   950   0005ea f1                   		pop	af
   951   0005eb fb                   		ei
   952   0005ec ed4d                 		reti
   953                          
   954   0005ee f5              resetConin: 	push	af				;disable timer 1 interrupt
   955   0005ef 3e01                 		ld	a, 01h
   956   0005f1 d381                 		out	(TC1), a
   957   0005f3 3eff                 		ld	a, 0ffh
   958   0005f5 3212ff               		ld	(TC1INTVEC), a
   959   0005f8 f1                   		pop	af
   960   0005f9 fb                   		ei
   961   0005fa ed4d                 		reti
   962                          ;--------------------------------------------------
   963                          ; SALLY Monitor
   964                          ;--------------------------------------------------
   965                          ;f5fc:
   966   0005fc f3              init9600:	di
   967   0005fd 21ee05               		ld	hl, resetConin			;point Timer 1 interrupt
   968   000600 2212ff               		ld	(TC1INTVEC), hl			;to 0f5eeh
   969   000603 3e07                 		ld	a, 07h				;Timer 1 reset, no int
   970   000605 d381                 		out	(TC1), a			;load time constant
   971   000607 3a0605               		ld	a, (baud9600 + 1)		;01ah = 9600 Baud
   972   00060a d381                 		out	(TC1), a
   973   00060c 2100ff               		ld	hl, 0ff00h
   974   00060f 222105               		ld	(coninIntPtr+1), hl
   975   000612 223306               		ld	(coninPtr), hl
   976   000615 f3                   		di
   977   000616 3e01                 		ld	a, 01h
   978   000618 d357                 		out	(CMDSIO), a			;enable SIO-Trig
   979   00061a 067e            init9600a:	ld	b, 7eh
   980   00061c db70            init9600c:	in	a, (SIOIN)			;read SIO
   981   00061e 17                   		rla					;D7 (RX) to carry
   982   00061f 30f9                 		jr	nc, init9600a			;0? repeat
   983   000621 10f9                 		djnz	init9600c			;high for 126 loops?
   984   000623 3ec7                 		ld	a, 0c7h				;T/C 0 interrupt on, counter mode, falling edge (start bit)
   985   000625 d380                 		out	(TC0), a
   986   000627 3e01                 		ld	a, 01h				;T/C 0, count just 1
   987   000629 d380                 		out	(TC0), a
   988   00062b 210005               		ld	hl, coninInt			;set T/C 0 int to 0f500h
   989   00062e 2210ff               		ld	(TC0INTVEC), hl
   990   000631 fb                   		ei
   991   000632 c9                   		ret
   992                          
   993   000633 00ff            coninPtr:	dw	0ff00h
   994                          
   995                          ;     		nop				;00
   996                          ;     		rst	38h			;ff
   997                          
   998                          ;--------------------------------------------------
   999                          ; const, is input from SIO ready?
  1000                          ;--------------------------------------------------
  1001                          f635:
  1002   000635 213306          const:     	ld	hl, coninPtr
  1003   000638 3a2105               		ld	a, (coninIntPtr + 1)
  1004   00063b 96                   		sub	(hl)
  1005   00063c c8                   		ret	z
  1006                          
  1007   00063d 3eff                 		ld	a, 0ffh
  1008   00063f c9                   		ret
  1009                          
  1010                          
  1011                          ;--------------------------------------------------
  1012                          ; conin
  1013                          ;--------------------------------------------------
  1014   000640 cd3506          conin:		call	const				;0f635h
  1015   000643 28fb                 		jr	z, conin			;input available?
  1016   000645 2a3306               		ld	hl, (coninPtr)			;read from buffer
  1017   000648 7e                   		ld	a, (hl)				;increment buffer pointer
  1018   000649 2c                   		inc	l
  1019   00064a cba5                 		res	4, l				;wrap at 16 bytes
  1020   00064c 223306               		ld	(coninPtr), hl
  1021   00064f c9                   		ret
  1022                          
  1023                          ;f650:
  1024   000650 3a12ff          conout:		ld	a, (TC1INTVEC)
  1025   000653 feee                 		cp	resetConin & 255
  1026   000655 38f9                 		jr	c, conout			; (-07h)
  1027   000657 79                   		ld	a, c
  1028   000658 e67f                 		and	7fh
  1029   00065a e25f06               		jp	po, conout1			;set parity
  1030   00065d f680                 		or	80h
  1031   00065f 325605          conout1:     	ld	(conoutIntB + 2), a		;set byte to output
  1032   000662 3e47                 		ld	a, conoutIntA & 255		;set conout interrupt
  1033   000664 3212ff               		ld	(TC1INTVEC), a
  1034   000667 3e81                 		ld	a, 81h
  1035   000669 d381                 		out	(TC1), a
  1036   00066b c9                   		ret
  1037                          
  1038                          
  1039   00066c e5              siowrite:     	push	hl				;save de, hl
  1040   00066d d5                   		push	de
  1041   00066e 2101c3               		ld	hl, 0c301h			;store e (complete) in 0c301
  1042   000671 73                   		ld	(hl), e
  1043   000672 1600                 		ld	d, 00h
  1044   000674 cd8406               		call	sioout
  1045   000677 d1                   		pop	de
  1046   000678 e1                   		pop	hl
  1047   000679 1e00                 		ld	e, 00h				;reset checksum
  1048   00067b cd8406               		call	sioout
  1049   00067e 2101c3               		ld	hl, 0c301h
  1050   000681 73                   		ld	(hl), e				;send checksum
  1051   000682 1600                 		ld	d, 00h
  1052                          
  1053                          ;--------------------------------------------------
  1054                          ; write to sio until hl = 0c300h, checksum in e
  1055                          ;--------------------------------------------------
  1056   000684 f3              sioout:     	di
  1057   000685 011907               		ld	bc, siooutintA
  1058   000688 ed4312ff             		ld	(TC1INTVEC), bc
  1059   00068c 0608                 		ld	b, 08h
  1060   00068e 3e87                 		ld	a, 87h				;timer interrupt
  1061   000690 d381                 		out	(TC1), a
  1062   000692 3e0d                 		ld	a, 0dh				;0dh = 13 ^= 19200 Baud
  1063   000694 d381                 		out	(TC1), a
  1064   000696 fb                   		ei
  1065   000697 18fe            sioout1:	jr	sioout1
  1066                          
  1067                          
  1068                          ;--------------------------------------------------
  1069                          ; SIO command frame interrupt
  1070                          ;--------------------------------------------------
  1071   000699 08              siocmdint:     	ex	af, af'
  1072   00069a d9                   		exx
  1073   00069b 3eff                 		ld	a, 0ffh				;read pending
  1074   00069d 3255ff               		ld	(0ff55h), a
  1075   0006a0 d357                 		out	(CMDSIO), a			;switch to sio
  1076   0006a2 21fbc2               		ld	hl, DDEVIC			;read 5 bytes command frame
  1077   0006a5 cdd906               		call	readSIO
  1078   0006a8 300a                 		jr	nc, siocmdint1			;read error, do nothing
  1079   0006aa 2b                   		dec	hl
  1080   0006ab 7e                   		ld	a, (hl)
  1081   0006ac b9                   		cp	c				;checksum correct?
  1082   0006ad 2005                 		jr	nz, siocmdint1			;no, do nothing
  1083   0006af 3e01                 		ld	a, 01h				;yes, frame received, set ff55 to 1
  1084   0006b1 3255ff               		ld	(0ff55h), a
  1085   0006b4 08              siocmdint1:	ex	af, af'
  1086   0006b5 d9                   		exx
  1087   0006b6 fb                   		ei
  1088   0006b7 ed4d                 		reti
  1089                          
  1090                          ;--------------------------------------------------
  1091                          ; reads up to 256 bytes from SIO, if more bytes read
  1092                          ; sends NACK
  1093                          ;--------------------------------------------------
  1094   0006b9 f3              sioread:	di
  1095   0006ba 2100c1               		ld	hl, 0c100h
  1096   0006bd cdd906               		call	readSIO
  1097   0006c0 fb                   		ei
  1098   0006c1 380d                 		jr	c, sendnack				;read until carry set
  1099   0006c3 2b                   		dec	hl
  1100   0006c4 7e                   		ld	a, (hl)					;check checksum
  1101   0006c5 b9                   		cp	c
  1102   0006c6 2008                 		jr	nz, sendnack				;not equal quit
  1103   0006c8 1100c1               		ld	de, 0c100h
  1104   0006cb b7                   		or	a					;clear carry
  1105   0006cc ed52                 		sbc	hl, de					;hl = number of bytes read
  1106   0006ce af                   		xor	a					;clear a
  1107   0006cf c9                   		ret
  1108                          
  1109   0006d0 3e4e            sendnack:	ld	a, 4eh					;04eh = 'N' = "NOT ACK"
  1110   0006d2 cd560c               		call	sendresp
  1111   0006d5 3eff                 		ld	a, 0ffh
  1112   0006d7 b7                   		or	a
  1113   0006d8 c9                   		ret
  1114                          
  1115                          ;--------------------------------------------------
  1116                          ; read from SIO to (hl) until hl = 0c300h
  1117                          ; carry clear, zero: no more input
  1118                          ; carry set: 0c300h reached
  1119                          ;--------------------------------------------------
  1120   0006d9 11aa0a          readSIO:     	ld	de, 0aaah			;read atari ser 19200 Baud
  1121   0006dc 010000               		ld	bc, 0000h
  1122   0006df 1823                 		jr	getstartbit
  1123                          
  1124   0006e1 79              readSIO1:	ld	a, c                            ;4	compute checksum in c
  1125   0006e2 80                   		add	a, b                            ;4
  1126   0006e3 ce00                 		adc	a, 00h                          ;7
  1127   0006e5 4f                   		ld	c, a                            ;4
  1128   0006e6 e3                   		ex	(sp), hl                        ;19
  1129   0006e7 e3                   		ex	(sp), hl                        ;19
  1130   0006e8 e3                   		ex	(sp), hl                        ;19
  1131   0006e9 e3                   		ex	(sp), hl                        ;19
  1132   0006ea 0608                 		ld	b, 08h                          ;7	102
  1133                          
  1134   0006ec 3e0b            readSIO2:	ld	a, 0bh				;7
  1135   0006ee 3e0b                 		ld	a, 0bh				;7
  1136   0006f0 00                   		nop					;4
  1137   0006f1 3d              readSIO3:    	dec	a				;4
  1138   0006f2 c2f106               		jp	nz, readSIO3			;10
  1139   0006f5 db70                 		in	a, (SIOIN)			;11
  1140   0006f7 17                   		rla					;4	bit7 to carry
  1141   0006f8 cb1a                 		rr	d				;8	carry lsb-wise in d
  1142   0006fa 10f0                 		djnz	readSIO2			;13	times
  1143                          
  1144   0006fc 42                   		ld	b, d				;save d in b
  1145   0006fd 72                   		ld	(hl), d				;also store in (hl)
  1146   0006fe 23                   		inc	hl				;increment hl
  1147   0006ff 7c                   		ld	a, h				;until hl = 0C300h
  1148   000700 fec3                 		cp	0c3h
  1149   000702 3f                   		ccf
  1150   000703 d8                   		ret	c				;carry set = 0C300h reached
  1151                          
  1152   000704 3e47            getstartbit:	ld	a, 47h				; CH0 noint+counter+pre16+falling autocnt+timeconst+reset+ctrl
  1153   000706 d380                 		out	(TC0), a                        ;        	 4              	7
  1154   000708 af                   		xor	a
  1155   000709 d380                 		out	(TC0), a                        ; counter init value 0
  1156   00070b 11a101               		ld	de, 01a1h
  1157   00070e db80            getstartbit1:	in	a, (TC0)                        ; counter zero?
  1158   000710 b7                   		or	a
  1159   000711 20ce                 		jr	nz, readSIO1			; start-bit
  1160   000713 1b                   		dec	de
  1161   000714 7a                   		ld	a, d
  1162   000715 b3                   		or	e                               ; carry clear
  1163   000716 20f6                 		jr	nz, getstartbit1		; de not zero, try again
  1164   000718 c9                   		ret                                     ; no startbit detected, return carry clear
  1165                          
  1166                          ;--------------------------------------------------
  1167                          ; SIO OUT Interrupt chain
  1168                          ;--------------------------------------------------
  1169   000719 af              siooutintA:     xor	a				;start bit
  1170   00071a d350                 		out	(SIOOUT), a
  1171   00071c fb                   		ei
  1172   00071d 7e                   		ld	a, (hl)
  1173   00071e 23                   		inc	hl
  1174   00071f aa                   		xor	d				;d = 0?
  1175   000720 4f                   		ld	c, a				;save a
  1176   000721 83                   		add	a, e				;compute checksum in e
  1177   000722 ce00                 		adc	a, 00h
  1178   000724 5f                   		ld	e, a
  1179   000725 3e2c                 		ld	a, siooutintB & 255
  1180   000727 3212ff               		ld	(TC1INTVEC), a
  1181   00072a ed4d                 		reti
  1182                          
  1183   00072c 79              siooutintB:     ld	a, c
  1184   00072d d350                 		out	(SIOOUT), a
  1185   00072f fb                   		ei
  1186   000730 cb19                 		rr	c
  1187   000732 1005                 		djnz	siooutintB1			;8 bits transferred?
  1188   000734 3e3b                 		ld	a, siooutintC & 255		;yes send stop bit
  1189   000736 3212ff               		ld	(TC1INTVEC), a
  1190   000739 ed4d            siooutintB1:	reti
  1191                          
  1192   00073b 3e01            siooutintC:  	ld	a, 01h				;stop bit
  1193   00073d d350                 		out	(SIOOUT), a
  1194   00073f fb                   		ei
  1195   000740 7c                   		ld	a, h
  1196   000741 fec3                 		cp	0c3h
  1197   000743 3009                 		jr	nc, siooutintD			;all data sent?
  1198   000745 0608                 		ld	b, 08h				;no, continue
  1199   000747 3e19                 		ld	a, siooutintA & 255
  1200   000749 3212ff               		ld	(TC1INTVEC), a
  1201   00074c ed4d                 		reti
  1202                          
  1203   00074e 3e55            siooutintD:	ld	a, siooutintE & 255
  1204   000750 3212ff               		ld	(TC1INTVEC), a
  1205   000753 ed4d                 		reti
  1206                          
  1207   000755 3e01            siooutintE:    	ld	a, 01h				;reset timer
  1208   000757 d381                 		out	(TC1), a
  1209   000759 fb                   		ei
  1210   00075a 3eff                 		ld	a, 0ffh
  1211   00075c 3212ff               		ld	(TC1INTVEC), a
  1212   00075f e1                   		pop	hl				;pop interrupt return, so return to caller
  1213   000760 ed4d                 		reti
  1214                          
  1215                          ;--------------------------------------------------
  1216                          ; Main entry after startup from ROM
  1217                          ;--------------------------------------------------
  1218   000762 3e01            main:     	ld	a, 01h           		;executed after startup
  1219   000764 d352                 		out	(ROMSWITCH), a         		;turn off ROM
  1220                          
  1221   000766 21fec2          read2bytes:	ld	hl, 0c2feh
  1222   000769 f3                   		di
  1223   00076a cdd906               		call	readSIO          		;read 2 bytes from SIO (until hl = c300)
  1224   00076d fb                   		ei
  1225   00076e 30f6                 		jr	nc, read2bytes			;nothing read within a timeframe,  read again
  1226   000770 2afec2               		ld	hl, (0c2feh)     		;load hl with bytes read
  1227   000773 11e680               		ld	de, 80e6h
  1228   000776 b7                   		or	a               		;clear carry
  1229   000777 ed52                 		sbc	hl, de
  1230   000779 cade03               		jp	z, sallymon        		;080e6h read? -> Sally Monitor
  1231                          
  1232   00077c 3e03                 		ld	a, 03h           		;no
  1233   00077e 3233ff               		ld	(0ff33h), a      		;store 03h in ff33h (03h = inc bc)
  1234   000781 3e38                 		ld	a, 38h           		;store 38h in f188h (038h = jr c,  d)
  1235   000783 3288f1               		ld	(0f188h), a
  1236   000786 db50                 		in	a, (SIOOUT)         		;test bit 3 of RS232 (jumper,  should be 1)
  1237   000788 cb5f                 		bit	3, a
  1238   00078a 2005                 		jr	nz, f791			;
  1239   00078c 3eff                 		ld	a, 0ffh          		;if zero,  store ffh (= rst 38h)
  1240   00078e 322308               		ld	(f823), a      			;to f823h (switch printer off?)
  1241   000791 21e107          f791:		ld	hl, return
  1242   000794 2219f0               		ld	(0f019h), hl			;hl points to RET
  1243   000797 ed5b1930             		ld	de, (3019h)
  1244   00079b b7                   		or	a
  1245   00079c ed52                 		sbc	hl, de
  1246   00079e 280c                 		jr	z, sioloop
  1247   0007a0 210000               		ld	hl, 0000h
  1248   0007a3 224bff               		ld	(0ff4bh), hl
  1249   0007a6 21ffbf               		ld	hl, 0bfffh
  1250   0007a9 224dff               		ld	(0ff4dh), hl
  1251                          
  1252                          ;--------------------------------------------------
  1253                          ; Looks like the main Atari SIO handler loop
  1254                          ;--------------------------------------------------
  1255   0007ac cdd1f8          sioloop:	call	0f8d1h				;output to printer? (check buffer)
  1256   0007af 2a3aff               		ld	hl, (0ff3ah)    		;sioidle	(ff3ah points to sioidle or cmdframe)
  1257   0007b2 cdbd07               		call	jumphl         			;call (ff3a)
  1258   0007b5 2a3cff               		ld	hl, (0ff3ch)    		;f7e1 (nomally return)
  1259   0007b8 cdbd07               		call	jumphl         			;call (ff3c)
  1260   0007bb 18ef                 		jr	sioloop
  1261                          
  1262   0007bd e9              jumphl:     	jp	(hl)
  1263                          
  1264   0007be db70            sioidle:     	in	a, (SIOIN)        		;in SIO
  1265   0007c0 e68a                 		and	8ah				;1---1-1-	;Stop-bit, no command (high) = idle
  1266   0007c2 fe8a                 		cp	8ah
  1267   0007c4 c0                   		ret	nz				;is not idle? return
  1268                          
  1269                          ;--------------------------------------------------
  1270                          ; program CTC to detect CMD
  1271                          ;--------------------------------------------------
  1272   0007c5 f3                   		di
  1273   0007c6 af                   		xor	a
  1274   0007c7 3255ff               		ld	(0ff55h), a			;select 0=CMD
  1275   0007ca d357                 		out	(CMDSIO), a
  1276   0007cc 3ed7                 		ld	a, 0d7h				;CH0 int+counter+pre16+rising autocnt+timeconst+reset+ctrl
  1277                          							;		D 				7
  1278   0007ce d380                 		out	(TC0), a                        ;program CTC, CMD is inverted, so detect rising edge
  1279   0007d0 3e01                 		ld	a, 01h
  1280   0007d2 d380                 		out	(TC0), a                        ;counter
  1281   0007d4 219906               		ld	hl, siocmdint			;load address of sio-cmd-interrupt
  1282   0007d7 2210ff               		ld	(TC0INTVEC), hl
  1283   0007da fb                   		ei
  1284   0007db 21e207               		ld	hl, cmdframe			;
  1285   0007de 223aff               		ld	(0ff3ah), hl
  1286   0007e1 c9              return:    	ret
  1287                          
  1288                          ;--------------------------------------------------
  1289                          ; handle command frame
  1290                          ;--------------------------------------------------
  1291   0007e2 3a55ff          cmdframe:     	ld	a, (0ff55h)
  1292   0007e5 b7                   		or	a
  1293   0007e6 c8                   		ret	z               		;no frame received yet
  1294                          
  1295   0007e7 fe01                 		cp	01h             		;frame received?
  1296   0007e9 2808                 		jr	z, cmdframe1			;handle it
  1297   0007eb f3                   		di
  1298   0007ec 3e03                 		ld	a, 03h           		;noint timer pre16 falling  reset vector
  1299   0007ee d380                 		out	(TC0), a         		;CTC Channel 0
  1300   0007f0 fb                   		ei
  1301   0007f1 1816                 		jr	cmdframe2
  1302                          
  1303   0007f3 3afbc2          cmdframe1:	ld	a, (DDEVIC)      		;load device ID
  1304   0007f6 2a38ff               		ld	hl, (0ff38h)			;load addr device table
  1305   0007f9 cd1008               		call	gettable
  1306   0007fc 200b                 		jr	nz, cmdframe2			;not found, return
  1307   0007fe 3afcc2               		ld	a, (DCOMND)			;load command
  1308   000801 cd1008               		call	gettable
  1309   000804 2003                 		jr	nz, cmdframe2			;not found;
  1310   000806 cdbd07               		call	jumphl				;call (hl)
  1311                          
  1312   000809 21be07          cmdframe2:	ld	hl, sioidle
  1313   00080c 223aff               		ld	(0ff3ah), hl
  1314   00080f c9                   		ret
  1315                          
  1316                          
  1317   000810 4e              gettable:    	ld	c, (hl)
  1318   000811 23                   		inc	hl
  1319   000812 46                   		ld	b, (hl)
  1320   000813 23                   		inc	hl
  1321   000814 edb1                 		cpir
  1322   000816 c0                   		ret	nz
  1323                          
  1324   000817 f5                   		push	af
  1325   000818 09                   		add	hl, bc
  1326   000819 09                   		add	hl, bc
  1327   00081a 09                   		add	hl, bc
  1328   00081b 7e                   		ld	a, (hl)
  1329   00081c 23                   		inc	hl
  1330   00081d 66                   		ld	h, (hl)
  1331   00081e 6f                   		ld	l, a
  1332   00081f f1                   		pop	af
  1333   000820 c9                   		ret
  1334                          
  1335   000821 0600            devicetab:	dw	06				;number of devices
  1336   000823 40              f823:		db	40h				;printer
  1337   000824 31323334        		db	31h, 32h, 33h, 34h		;disk 1-4
  1338   000828 5a              		db	'Z'				;Z80
  1339                          
  1340   000829 54f8            		dw	0f854h				;Z80
  1341   00082b 3df8            		dw	0f83dh				;Disk 4
  1342   00082d 3df8            		dw	0f83dh				;Disk 3
  1343   00082f 3df8            		dw	0f83dh				;Disk 2
  1344   000831 3df8            		dw	0f83dh				;Disk 1
  1345   000833 35f8            		dw	0f835h				;printer
  1346                          
  1347   000835 0200            		dw	2				;printer commands
  1348   000837 53              		db	53h				;status
  1349   000838 57              		db	57h				;write
  1350   000839 78f8            		dw	0f878h
  1351   00083b 62f8            		dw	0f862h
  1352                          
  1353   00083d 0700            		dw	7				;disk commands
  1354   00083f 52              		db	52h				;read		'R'
  1355   000840 53              		db	53h				;status		'S'
  1356   000841 57              		db	57h				;write		'W'
  1357   000842 50              		db	50h				;putchar	'P'
  1358   000843 4e              		db	4eh				;percom read	'N'
  1359   000844 4f              		db	4fh				;perfom write	'O'
  1360   000845 21              		db	21h				;format		'!'
  1361   000846 38fb            		dw	0fb38h				;format vector
  1362   000848 050c            		dw	percomwrite			;percom write vector
  1363   00084a e70b            		dw	percomread			;percom read vector
  1364   00084c 05f9            		dw	0f905h				;disk putchar vector
  1365   00084e 08f9            		dw	0f908h				;disk write vector
  1366   000850 dbfa            		dw	0fadbh				;disk status vector
  1367   000852 8c09            		dw	diskread			;disk read vector
  1368                          
  1369   000854 0400            		dw	4				;printer commands
  1370   000856 52              		db	52h				;read
  1371   000857 57              		db      57h				;write
  1372   000858 53              		db      53h				;status
  1373   000859 47              		db	47h				;?
  1374   00085a b4fc            		dw	0fcb4h
  1375   00085c a6fc            		dw	0fca6h
  1376   00085e 7bfc            		dw	0fc7bh
  1377   000860 5ffc            		dw	0fc5fh
  1378                          
  1379   000862 cd4a0c               		call	sendack
  1380   000865 2143ff               		ld	hl, 0ff43h
  1381   000868 11fcc2               		ld	de, 0c2fch
  1382   00086b d5                   		push	de
  1383   00086c 010400               		ld	bc, 0004h
  1384   00086f edb0                 		ldir
  1385   000871 e1                   		pop	hl
  1386   000872 114300               		ld	de, 0043h
  1387   000875 c36c06               		jp	siowrite
  1388   000878 cd4a0c               		call	sendack
  1389   00087b cdb906               		call	sioread
  1390   00087e c0                   		ret	nz				;not zero, error
  1391                          
  1392   00087f 112800               		ld	de, 0028h
  1393   000882 b7                   		or	a
  1394   000883 ed52                 		sbc	hl, de
  1395   000885 c0                   		ret	nz
  1396                          
  1397   000886 cd4a0c               		call	sendack
  1398   000889 2100c1               		ld	hl, 0c100h
  1399   00088c 0628                 		ld	b, 28h
  1400   00088e 7e              f88e:		ld	a, (hl)
  1401   00088f fe9b                 		cp	9bh
  1402   000891 2005                 		jr	nz, f898		; (+05h)
  1403   000893 213eff               		ld	hl, 0ff3eh
  1404   000896 46                   		ld	b, (hl)
  1405   000897 23                   		inc	hl
  1406   000898 e5              f898:		push	hl
  1407   000899 2a4fff               		ld	hl, (0ff4fh)
  1408   00089c ed5b4dff             		ld	de, (0ff4dh)
  1409   0008a0 b7                   		or	a
  1410   0008a1 ed52                 		sbc	hl, de
  1411   0008a3 e1                   		pop	hl
  1412   0008a4 380e                 		jr	c, f8b4		; (+0eh)
  1413   0008a6 e5                   		push	hl
  1414   0008a7 c5                   		push	bc
  1415   0008a8 cdd1f8               		call	0f8d1h
  1416   0008ab c1                   		pop	bc
  1417   0008ac e1                   		pop	hl
  1418   0008ad db70                 		in	a, (SIOIN)
  1419   0008af e602                 		and	02h
  1420   0008b1 20e5                 		jr	nz, f898		; (-1bh)
  1421   0008b3 c9                   		ret
  1422                          
  1423   0008b4 7e              f8b4:		ld	a, (hl)
  1424   0008b5 23                   		inc	hl
  1425   0008b6 e5                   		push	hl
  1426   0008b7 c5                   		push	bc
  1427   0008b8 2a51ff               		ld	hl, (0ff51h)
  1428   0008bb cdf1f8               		call	0f8f1h
  1429   0008be ed5351ff             		ld	(0ff51h), de
  1430   0008c2 77                   		ld	(hl), a
  1431   0008c3 2a4fff               		ld	hl, (0ff4fh)
  1432   0008c6 23                   		inc	hl
  1433   0008c7 224fff               		ld	(0ff4fh), hl
  1434   0008ca c1                   		pop	bc
  1435   0008cb e1                   		pop	hl
  1436   0008cc 10c0                 		djnz	f88e		; (-40h)
  1437   0008ce c354fc               		jp	0fc54h
  1438                          
  1439   0008d1 2a4fff          f8d1:     	ld	hl, (0ff4fh)			;is pointer in ff4f zero?
  1440   0008d4 7c                   		ld	a, h
  1441   0008d5 b5                   		or	l
  1442   0008d6 c8                   		ret	z				;normally yes, return
  1443                          
  1444   0008d7 cd15f0               		call	0f015h
  1445   0008da c0                   		ret	nz
  1446                          
  1447   0008db 2a53ff               		ld	hl, (0ff53h)
  1448   0008de cdf1f8               		call	0f8f1h
  1449   0008e1 ed5353ff             		ld	(0ff53h), de
  1450   0008e5 4e                   		ld	c, (hl)
  1451   0008e6 cd12f0               		call	0f012h
  1452   0008e9 2a4fff               		ld	hl, (0ff4fh)
  1453   0008ec 2b                   		dec	hl
  1454   0008ed 224fff               		ld	(0ff4fh), hl
  1455   0008f0 c9                   		ret
  1456                          
  1457   0008f1 eb                   		ex	de, hl
  1458   0008f2 2a4bff               		ld	hl, (0ff4bh)
  1459   0008f5 19                   		add	hl, de
  1460   0008f6 e5                   		push	hl
  1461   0008f7 13                   		inc	de
  1462   0008f8 2a4dff               		ld	hl, (0ff4dh)
  1463   0008fb b7                   		or	a
  1464   0008fc ed52                 		sbc	hl, de
  1465   0008fe 3003                 		jr	nc, f903		; (+03h)
  1466   000900 110000               		ld	de, 0000h
  1467   000903 e1              f903:		pop	hl
  1468   000904 c9                   		ret
  1469                          
  1470   000905 af                   		xor	a
  1471   000906 1802                 		jr	f90a		; (+02h)
  1472   000908 3e01                 		ld	a, 01h
  1473   00090a 32b5ff          f90a:		ld	(0ffb5h), a
  1474   00090d cd280c               		call	checkdiskno
  1475   000910 d8                   		ret	c
  1476                          
  1477   000911 cd4a0c               		call	sendack
  1478   000914 cdb906               		call	sioread
  1479   000917 c0                   		ret	nz
  1480                          
  1481   000918 22a9ff               		ld	(0ffa9h), hl
  1482   00091b 118000               		ld	de, 0080h
  1483   00091e b7                   		or	a
  1484   00091f ed52                 		sbc	hl, de
  1485   000921 2804                 		jr	z, f927		; (+04h)
  1486   000923 b7                   		or	a
  1487   000924 ed52                 		sbc	hl, de
  1488   000926 c0                   		ret	nz
  1489                          
  1490   000927 cd4a0c          f927:		call	sendack
  1491   00092a cd10fa               		call	0fa10h
  1492   00092d 204e                 		jr	nz, f97d		; (+4eh)
  1493   00092f 2100c1               		ld	hl, 0c100h
  1494   000932 229cff               		ld	(0ff9ch), hl
  1495   000935 3aa9ff               		ld	a, (0ffa9h)
  1496   000938 47                   		ld	b, a
  1497   000939 7e              f939:		ld	a, (hl)
  1498   00093a 2f                   		cpl
  1499   00093b 77                   		ld	(hl), a
  1500   00093c 23                   		inc	hl
  1501   00093d 10fa                 		djnz	f939		; (-06h)
  1502   00093f 3e02                 		ld	a, 02h
  1503   000941 3298ff               		ld	(0ff98h), a
  1504   000944 dd2198ff             		ld	ix, 0ff98h
  1505   000948 cd0ff0               		call	0f00fh
  1506   00094b 3aa0ff               		ld	a, (0ffa0h)
  1507   00094e b7                   		or	a
  1508   00094f 202c                 		jr	nz, f97d		; (+2ch)
  1509   000951 3ab5ff               		ld	a, (0ffb5h)
  1510   000954 b7                   		or	a
  1511   000955 2826                 		jr	z, f97d		; (+26h)
  1512   000957 3e01                 		ld	a, 01h
  1513   000959 3298ff               		ld	(0ff98h), a
  1514   00095c 2100c3               		ld	hl, 0c300h
  1515   00095f 229cff               		ld	(0ff9ch), hl
  1516   000962 cd0ff0               		call	0f00fh
  1517   000965 3aa0ff               		ld	a, (0ffa0h)
  1518   000968 b7                   		or	a
  1519   000969 2012                 		jr	nz, f97d		; (+12h)
  1520   00096b 2100c1               		ld	hl, 0c100h
  1521   00096e 1100c3               		ld	de, 0c300h
  1522   000971 3a9eff               		ld	a, (0ff9eh)
  1523   000974 47                   		ld	b, a
  1524   000975 1a              f975:		ld	a, (de)
  1525   000976 ae                   		xor	(hl)
  1526   000977 200b                 		jr	nz, f984		; (+0bh)
  1527   000979 23                   		inc	hl
  1528   00097a 13                   		inc	de
  1529   00097b 10f8                 		djnz	f975		; (-08h)
  1530   00097d cde3f9          f97d:		call	0f9e3h
  1531   000980 7b                   		ld	a, e
  1532   000981 c356fc               		jp	0fc56h
  1533   000984 af              f984:		xor	a
  1534   000985 cd06fa               		call	0fa06h
  1535   000988 7b                   		ld	a, e
  1536   000989 c356fc               		jp	0fc56h
  1537                          
  1538                          ;--------------------------------------------------
  1539                          ; reads a sector from disk and sends it to SIO
  1540                          ;DDEVIC		equ	0c2fbh
  1541                          ;DCOMND		equ	0c2fch
  1542                          ;DAUX1		equ	0c2fdh
  1543                          ;DAUX2		equ	0c2feh
  1544                          ;DCHECK		equ	0c2ffh
  1545                          ;;--------------------------------------------------
  1546   00098c cd280c          diskread:	call	checkdiskno
  1547   00098f d8                   		ret	c
  1548                          
  1549   000990 cd4a0c               		call	sendack
  1550   000993 cd100a               		call	fa10				;percom present???
  1551   000996 f5                   		push	af
  1552   000997 280f                 		jr	z, f9a8				;if zero, don't take sec-size from percom-block
  1553   000999 fd5606               		ld	d, (iy+06h)			;bytes per sector high
  1554   00099c fd5e07               		ld	e, (iy+07h)			;bytes per sector low
  1555   00099f 7a                   		ld	a, d				;check if zero
  1556   0009a0 b3                   		or	e
  1557   0009a1 2009                 		jr	nz, f9ac			;non-zero
  1558   0009a3 118000               		ld	de, 0080h			;otherwise assume 128 bytes
  1559   0009a6 1804                 		jr	f9ac
  1560   0009a8 ed5b9eff        f9a8:		ld	de, (0ff9eh)			;current (or default?) sector size
  1561   0009ac 2afdc2          f9ac:		ld	hl, (DAUX1)			;sector number in cmd-frame
  1562   0009af 010400               		ld	bc, 0004h
  1563   0009b2 b7                   		or	a
  1564   0009b3 ed42                 		sbc	hl, bc				;<4?
  1565   0009b5 3003                 		jr	nc, f9ba			;no
  1566   0009b7 118000               		ld	de, 0080h			;otherwise, assume 128 bytes
  1567   0009ba ed53a9ff        f9ba:		ld	(0ffa9h), de			;save sector-size
  1568   0009be 2100c3               		ld	hl, 0c300h
  1569   0009c1 b7                   		or	a				;clear carry
  1570   0009c2 ed52                 		sbc	hl, de				;compute buffer start
  1571   0009c4 f1                   		pop	af
  1572   0009c5 2014                 		jr	nz, f9db			;jump if percom present
  1573   0009c7 229cff               		ld	(0ff9ch), hl			;save buffer start in 0ff9ch
  1574   0009ca 3e01                 		ld	a, 01h
  1575   0009cc 3298ff               		ld	(0ff98h), a			;1 to 0ff98h
  1576   0009cf dd2198ff             		ld	ix, 0ff98h			;load control-block to ix?
  1577   0009d3 e5                   		push	hl				;save hl
  1578   0009d4 cd0ff0               		call	0f00fh				;call sector-read?
  1579   0009d7 e1                   		pop	hl				;retrieve hl
  1580   0009d8 3aa0ff               		ld	a, (0ffa0h)
  1581   0009db cde309          f9db:		call	f9e3
  1582   0009de 16ff                 		ld	d, 0ffh
  1583   0009e0 c36c06               		jp	siowrite
  1584                          
  1585   0009e3 b7              f9e3:     	or	a				;accu zero?
  1586   0009e4 200a                 		jr	nz, f9f0			;no percom block
  1587   0009e6 fd770d               		ld	(iy+0dh), a
  1588   0009e9 1e43                 		ld	e, 43h				;load 'C' = "complete"
  1589   0009eb fdcb0c96             		res	2, (iy+0ch)			;reset bit 2 in percom+12
  1590   0009ef c9                   		ret
  1591                          
  1592   0009f0 cb77            f9f0:		bit	6, a
  1593   0009f2 2802                 		jr	z, f9f6		; (+02h)
  1594   0009f4 e69f                 		and	9fh
  1595   0009f6 cb6f            f9f6:		bit	5, a
  1596   0009f8 2802                 		jr	z, f9fc		; (+02h)
  1597   0009fa f660                 		or	60h
  1598   0009fc 4f              f9fc:		ld	c, a
  1599   0009fd e681                 		and	81h
  1600   0009ff 79                   		ld	a, c
  1601   000a00 2804                 		jr	z, fa06		; (+04h)
  1602   000a02 e67e                 		and	7eh
  1603   000a04 f610                 		or	10h
  1604   000a06 fd770d          fa06:		ld	(iy+0dh), a
  1605   000a09 1e45                 		ld	e, 45h
  1606   000a0b fdcb0cd6             		set	2, (iy+0ch)
  1607   000a0f c9                   		ret
  1608                          
  1609                          
  1610                          ;--------------------------------------------------
  1611                          ;
  1612                          ;--------------------------------------------------
  1613   000a10 3a2eff          fa10:     	ld	a, (0ff2eh)			;check if 0ff2eh zero
  1614   000a13 b7                   		or	a
  1615   000a14 2811                 		jr	z, fa27				;yes
  1616   000a16 af                   		xor	a
  1617   000a17 322eff               		ld	(0ff2eh), a			;set to zero
  1618   000a1a 2164ff               		ld	hl, PERCOMBLOCKS + 0eh		;reset bit 0 of all 4 PERCOMBLOCK+14
  1619   000a1d 111000               		ld	de, 0010h
  1620   000a20 0604                 		ld	b, 04h
  1621   000a22 cb86            fa22:		res	0, (hl)
  1622   000a24 19                   		add	hl, de
  1623   000a25 10fb                 		djnz	fa22				;loop 4 times
  1624                          
  1625   000a27 fdcb0e46        fa27:		bit	0, (iy + 0eh)			;bit 0 of PERCOMBLOCK+14 set?
  1626   000a2b 206d                 		jr	nz, fa9a			;no
  1627   000a2d 3e03                 		ld	a, 03h				;store 3 to 0ff98h
  1628   000a2f 3298ff               		ld	(0ff98h), a
  1629   000a32 3a99ff               		ld	a, (0ff99h)
  1630   000a35 2120ff               		ld	hl, 0ff20h
  1631   000a38 85                   		add	a, l
  1632   000a39 6f                   		ld	l, a
  1633   000a3a 7e                   		ld	a, (hl)
  1634   000a3b fe50                 		cp	50h
  1635   000a3d 3801                 		jr	c, fa40		; (+01h)
  1636   000a3f af                   		xor	a
  1637   000a40 329aff          fa40:		ld	(0ff9ah), a
  1638   000a43 21abff               		ld	hl, 0ffabh
  1639   000a46 229cff               		ld	(0ff9ch), hl
  1640   000a49 dd2198ff             		ld	ix, 0ff98h
  1641   000a4d cd0ff0               		call	0f00fh
  1642   000a50 3aa0ff               		ld	a, (0ffa0h)
  1643   000a53 b7                   		or	a
  1644   000a54 c0                   		ret	nz
  1645                          
  1646   000a55 3aaeff               		ld	a, (0ffaeh)
  1647   000a58 cdcdfa               		call	0facdh
  1648   000a5b fd7006               		ld	(iy+06h), b
  1649   000a5e fd7107               		ld	(iy+07h), c
  1650   000a61 3a9eff               		ld	a, (0ff9eh)
  1651   000a64 07                   		rlca
  1652   000a65 07                   		rlca
  1653   000a66 07                   		rlca
  1654   000a67 2f                   		cpl
  1655   000a68 e606                 		and	06h
  1656   000a6a fd7705               		ld	(iy+05h), a
  1657   000a6d cb4f                 		bit	1, a
  1658   000a6f 2807                 		jr	z, fa78		; (+07h)
  1659   000a71 3e4d                 		ld	a, 4dh
  1660   000a73 211a00               		ld	hl, 001ah
  1661   000a76 1805                 		jr	fa7d		; (+05h)
  1662   000a78 3e28            fa78:		ld	a, 28h
  1663   000a7a 211200               		ld	hl, 0012h
  1664   000a7d fdbe00          fa7d:		cp	(iy+00h)
  1665   000a80 3803                 		jr	c, fa85		; (+03h)
  1666   000a82 fd7700               		ld	(iy+00h), a
  1667   000a85 fd7402          fa85:		ld	(iy+02h), h
  1668   000a88 fd7503               		ld	(iy+03h), l
  1669   000a8b fdcb0ec6             		set	0, (iy+0eh)
  1670   000a8f 2a96ff               		ld	hl, (0ff96h)
  1671   000a92 7c                   		ld	a, h
  1672   000a93 b5                   		or	l
  1673   000a94 2004                 		jr	nz, fa9a		; (+04h)
  1674   000a96 fd2296ff             		ld	(0ff96h), iy
  1675   000a9a 2afdc2          fa9a:		ld	hl, (0c2fdh)
  1676   000a9d 2b                   		dec	hl
  1677   000a9e 1600                 		ld	d, 00h
  1678   000aa0 fd5e03               		ld	e, (iy+03h)
  1679   000aa3 3eff                 		ld	a, 0ffh
  1680   000aa5 3c              faa5:		inc	a
  1681   000aa6 b7                   		or	a
  1682   000aa7 ed52                 		sbc	hl, de
  1683   000aa9 30fa                 		jr	nc, faa5		; (-06h)
  1684   000aab 19                   		add	hl, de
  1685   000aac 23                   		inc	hl
  1686   000aad 4d                   		ld	c, l
  1687   000aae 219bff               		ld	hl, 0ff9bh
  1688   000ab1 71                   		ld	(hl), c
  1689   000ab2 fdbe00               		cp	(iy+00h)
  1690   000ab5 3808                 		jr	c, fabf		; (+08h)
  1691   000ab7 fd9600               		sub	(iy+00h)
  1692   000aba 2199ff               		ld	hl, 0ff99h
  1693   000abd cbfe                 		set	7, (hl)
  1694   000abf 329aff          fabf:		ld	(0ff9ah), a
  1695   000ac2 fd6606               		ld	h, (iy+06h)
  1696   000ac5 fd6e07               		ld	l, (iy+07h)
  1697   000ac8 229eff               		ld	(0ff9eh), hl
  1698   000acb af                   		xor	a
  1699   000acc c9                   		ret
  1700                          
  1701   000acd 018000               		ld	bc, 0080h
  1702   000ad0 e603                 		and	03h
  1703   000ad2 c8                   		ret	z
  1704                          
  1705   000ad3 cb21            fad3:		sla	c
  1706   000ad5 cb10                 		rl	b
  1707   000ad7 3d                   		dec	a
  1708   000ad8 20f9                 		jr	nz, fad3		; (-07h)
  1709   000ada c9                   		ret
  1710                          
  1711   000adb cd280c               		call	checkdiskno
  1712   000ade d8                   		ret	c
  1713                          
  1714   000adf cd4a0c               		call	sendack
  1715   000ae2 cdd3fb               		call	0fbd3h
  1716   000ae5 3ac9ff               		ld	a, (0ffc9h)
  1717   000ae8 f5                   		push	af
  1718   000ae9 3e00                 		ld	a, 00h
  1719   000aeb 3298ff               		ld	(0ff98h), a
  1720   000aee dd2198ff             		ld	ix, 0ff98h
  1721   000af2 cd0ff0               		call	0f00fh
  1722   000af5 fd4e0c               		ld	c, (iy+0ch)
  1723   000af8 fd360c00             		ld	(iy+0ch), 00h
  1724   000afc f1                   		pop	af
  1725   000afd b7                   		or	a
  1726   000afe 2804                 		jr	z, fb04		; (+04h)
  1727   000b00 cbe1                 		set	4, c
  1728   000b02 1802                 		jr	fb06		; (+02h)
  1729   000b04 cba1            fb04:		res	4, c
  1730   000b06 fdcb0556        fb06:		bit	2, (iy+05h)
  1731   000b0a 2804                 		jr	z, fb10		; (+04h)
  1732   000b0c cbe9                 		set	5, c
  1733   000b0e 1802                 		jr	fb12		; (+02h)
  1734   000b10 cba9            fb10:		res	5, c
  1735   000b12 ddcb0876        fb12:		bit	6, (ix+08h)
  1736   000b16 2804                 		jr	z, fb1c		; (+04h)
  1737   000b18 cbd9                 		set	3, c
  1738   000b1a 1802                 		jr	fb1e		; (+02h)
  1739   000b1c cb99            fb1c:		res	3, c
  1740   000b1e 21fcc2          fb1e:		ld	hl, 0c2fch
  1741   000b21 e5                   		push	hl
  1742   000b22 71                   		ld	(hl), c
  1743   000b23 23                   		inc	hl
  1744   000b24 fd7e0d               		ld	a, (iy+0dh)
  1745   000b27 2f                   		cpl
  1746   000b28 77                   		ld	(hl), a
  1747   000b29 23                   		inc	hl
  1748   000b2a 36e0                 		ld	(hl), 0e0h
  1749   000b2c 23                   		inc	hl
  1750   000b2d 3a2dff               		ld	a, (0ff2dh)
  1751   000b30 77                   		ld	(hl), a
  1752   000b31 e1                   		pop	hl
  1753   000b32 114300               		ld	de, 0043h			;e = 43h = complete
  1754   000b35 c36c06               		jp	siowrite
  1755   000b38 cd280c               		call	checkdiskno
  1756   000b3b d8                   		ret	c
  1757                          
  1758   000b3c 2a4fff               		ld	hl, (0ff4fh)
  1759   000b3f 7c                   		ld	a, h
  1760   000b40 b5                   		or	l
  1761   000b41 c0                   		ret	nz
  1762                          
  1763   000b42 cdd3fb               		call	0fbd3h
  1764   000b45 c8                   		ret	z
  1765                          
  1766   000b46 cd4a0c               		call	sendack
  1767   000b49 3e00                 		ld	a, 00h
  1768   000b4b 3298ff               		ld	(0ff98h), a
  1769   000b4e dd2198ff             		ld	ix, 0ff98h
  1770   000b52 cd0ff0               		call	0f00fh
  1771   000b55 cdcbf3               		call	0f3cbh
  1772   000b58 3a2fff               		ld	a, (0ff2fh)
  1773   000b5b fdcb0556             		bit	2, (iy+05h)
  1774   000b5f 2807                 		jr	z, fb68		; (+07h)
  1775   000b61 cbbf                 		res	7, a
  1776   000b63 2100c2               		ld	hl, 0c200h
  1777   000b66 1805                 		jr	fb6d		; (+05h)
  1778   000b68 cbff            fb68:		set	7, a
  1779   000b6a 2180c2               		ld	hl, 0c280h
  1780   000b6d 322fff          fb6d:		ld	(0ff2fh), a
  1781   000b70 d330                 		out	(DISKCTRL), a
  1782   000b72 e5                   		push	hl
  1783   000b73 22c1ff               		ld	(0ffc1h), hl
  1784   000b76 210100               		ld	hl, 0001h
  1785   000b79 22bfff               		ld	(0ffbfh), hl
  1786   000b7c 2a49ff               		ld	hl, (0ff49h)
  1787   000b7f 11b6ff               		ld	de, 0ffb6h
  1788   000b82 010700               		ld	bc, 0007h
  1789   000b85 07                   		rlca
  1790   000b86 07                   		rlca
  1791   000b87 e603                 		and	03h
  1792   000b89 2804                 		jr	z, fb8f		; (+04h)
  1793   000b8b 09              fb8b:		add	hl, bc
  1794   000b8c 3d                   		dec	a
  1795   000b8d 20fc                 		jr	nz, fb8b		; (-04h)
  1796   000b8f edb0            fb8f:		ldir
  1797   000b91 3aa0ff               		ld	a, (0ffa0h)
  1798   000b94 e6c0                 		and	0c0h
  1799   000b96 2013                 		jr	nz, fbab		; (+13h)
  1800   000b98 fd7e04               		ld	a, (iy+04h)
  1801   000b9b 32bdff               		ld	(0ffbdh), a
  1802   000b9e fd7e00               		ld	a, (iy+00h)
  1803   000ba1 32beff               		ld	(0ffbeh), a
  1804   000ba4 fde5                 		push	iy
  1805   000ba6 cdbefc               		call	0fcbeh
  1806   000ba9 fde1                 		pop	iy
  1807   000bab e1              fbab:		pop	hl
  1808   000bac cde3f9               		call	0f9e3h
  1809   000baf 1600                 		ld	d, 00h
  1810   000bb1 cd6c06               		call	siowrite
  1811   000bb4 c33c00               		jp	readsector1
  1812   000bb7 9f                   		sbc	a, a
  1813   000bb8 fee2                 		cp	0e2h
  1814   000bba fe1a                 		cp	1ah
  1815   000bbc b0                   		or	b
  1816   000bbd 2835                 		jr	z, fbf4		; (+35h)
  1817   000bbf fe68                 		cp	68h
  1818   000bc1 fe12                 		cp	12h
  1819   000bc3 6a                   		ld	l, d
  1820   000bc4 187a                 		jr	ASMPC+2+07ah	; (+7ah)
  1821   000bc6 fec8                 		cp	0c8h
  1822   000bc8 fe1a                 		cp	1ah
  1823   000bca 58                   		ld	e, b
  1824   000bcb 14                   		inc	d
  1825   000bcc 16fe                 		ld	d, 0feh
  1826   000bce 56                   		ld	d, (hl)
  1827   000bcf fe12                 		cp	12h
  1828   000bd1 35                   		dec	(hl)
  1829   000bd2 0c                   		inc	c
  1830   000bd3 fd7e00          fbd3:     	ld	a, (iy+00h)			;get DCB byte 0
  1831   000bd6 b7                   		or	a
  1832   000bd7 c0                   		ret	nz				;return if nz
  1833                          
  1834   000bd8 2a96ff               		ld	hl, (0ff96h)			;pointer zero
  1835   000bdb 7c                   		ld	a, h
  1836   000bdc b5                   		or	l
  1837   000bdd c8                   		ret	z				;yes, leave
  1838                          
  1839   000bde fde5                 		push	iy
  1840   000be0 d1                   		pop	de
  1841   000be1 010c00               		ld	bc, 000ch
  1842   000be4 edb0                 		ldir
  1843   000be6 c9                   		ret
  1844                          
  1845                          
  1846                          ;Byte #  # of   Description
  1847                          ;           Bytes
  1848                          ;     0       1    Number of Tracks
  1849                          ;     1       1    Step Rate (values have no universal meaning)
  1850                          ;    2-3      2    Sectors per Track (byte 2 is high byte; byte 3 is low byte)
  1851                          ;     4       1    Number of Sides or Heads (0=one head, 1=two heads)
  1852                          ;     5       1    Density (0=FM/Single, 4=MFM/Double)
  1853                          ;    6-7      2    Bytes per Sector (byte 6 is high byte; byte 7 is low byte)
  1854                          ;     8       1    Drive Selected/Online?
  1855                          ;     9       1    Serial Rate Control (values have no universal meaning)
  1856                          ;   10-11     2    Miscellaneous (reserved)
  1857                          ;--------------------------------------------------
  1858                          ; send percom block to sio
  1859                          ;--------------------------------------------------
  1860   000be7 cd280c          percomread:     call	checkdiskno
  1861   000bea d8                   		ret	c				;do nothing if carry set
  1862                          
  1863   000beb cdd30b               		call	fbd3
  1864   000bee c8                   		ret	z
  1865                          
  1866   000bef cd4a0c               		call	sendack				;acknowledge command frame
  1867   000bf2 fde5                 		push	iy
  1868   000bf4 e1              fbf4:		pop	hl
  1869   000bf5 11f4c2               		ld	de, 0c2f4h			;copy 12 bytes percom block
  1870   000bf8 d5                   		push	de				;to c2f4 (SIOBUFFER)
  1871   000bf9 010c00               		ld	bc, 000ch
  1872   000bfc edb0                 		ldir
  1873   000bfe e1                   		pop	hl
  1874   000bff 114300               		ld	de, 0043h			;e = C = complete
  1875   000c02 c36c06               		jp	siowrite
  1876                          
  1877                          ;--------------------------------------------------
  1878                          ; read percom block from sio and store it
  1879                          ;--------------------------------------------------
  1880   000c05 cd280c          percomwrite:    call	checkdiskno			;check diskno and get percomblock in iy
  1881   000c08 d8                   		ret	c
  1882                          
  1883   000c09 cd4a0c               		call	sendack
  1884   000c0c cdb906               		call	sioread
  1885   000c0f c0                   		ret	nz
  1886                          
  1887   000c10 110c00               		ld	de, 000ch			;12 bytes read?
  1888   000c13 b7                   		or	a
  1889   000c14 ed52                 		sbc	hl, de
  1890   000c16 c0                   		ret	nz				;if not, return
  1891                          
  1892   000c17 cd4a0c               		call	sendack				;send acknowledge
  1893   000c1a 2100c1               		ld	hl, 0c100h			;copy 12 bytes
  1894   000c1d fde5                 		push	iy				;into PERCOM-block in iy
  1895   000c1f d1                   		pop	de
  1896   000c20 010c00               		ld	bc, 000ch
  1897   000c23 edb0                 		ldir
  1898   000c25 c3540c               		jp	sendcomp			;send complete
  1899                          
  1900                          
  1901   000c28 3afbc2          checkdiskno:	ld	a, (DDEVIC)			;check if D1-D4
  1902   000c2b d631                 		sub	31h
  1903   000c2d fe04                 		cp	04h
  1904   000c2f 3f                   		ccf
  1905   000c30 d8                   		ret	c				;return carry set if > 4
  1906                          
  1907   000c31 2600            getpercomadr:	ld	h, 00h				;hl = a * 16
  1908   000c33 6f                   		ld	l, a
  1909   000c34 29                   		add	hl, hl				;mul 16
  1910   000c35 29                   		add	hl, hl
  1911   000c36 29                   		add	hl, hl
  1912   000c37 29                   		add	hl, hl
  1913   000c38 0156ff               		ld	bc, PERCOMBLOCKS
  1914   000c3b 09                   		add	hl, bc				;PERCOMBLOCKS + diskno * 16
  1915   000c3c e5                   		push	hl				;iy = hl
  1916   000c3d fde1                 		pop	iy
  1917   000c3f fdcb0876             		bit	6, (iy+08h)			;test iy+8h bit6 drive online?
  1918   000c43 37                   		scf					;set carry
  1919   000c44 c8                   		ret	z				;return if bit clear
  1920                          
  1921   000c45 3299ff               		ld	(0ff99h), a			;otherwise write diskno to 0ff99h
  1922   000c48 af                   		xor	a				;clear acc and carry
  1923   000c49 c9                   		ret
  1924                          
  1925                          
  1926                          
  1927   000c4a db70            sendack:	in	a, (SIOIN)
  1928   000c4c cb4f                 		bit	1, a
  1929   000c4e 28fa                 		jr	z, sendack			;wait until CMD high
  1930   000c50 3e41                 		ld	a, 41h				;load 'A' (acknowledge)
  1931   000c52 1802                 		jr	sendresp
  1932                          
  1933   000c54 3e43            sendcomp:     	ld	a, 43h				;'C' = "complete"
  1934                          
  1935   000c56 2101c3          sendresp:	ld	hl, 0c301h			;save to 0c301h
  1936   000c59 77                   		ld	(hl), a
  1937   000c5a 1600                 		ld	d, 00h				;d = 0
  1938   000c5c c38406               		jp	sioout
  1939                          
  1940                          
  1941                          
  1942   000c5f cd4a0c               		call	sendack
  1943   000c62 cd9cfc               		call	0fc9ch
  1944   000c65 2100c3               		ld	hl, 0c300h
  1945   000c68 b7                   		or	a
  1946   000c69 ed42                 		sbc	hl, bc
  1947   000c6b e5                   		push	hl
  1948   000c6c eb                   		ex	de, hl
  1949   000c6d 2ab2fc               		ld	hl, (0fcb2h)
  1950   000c70 f3                   		di
  1951   000c71 edb0                 		ldir
  1952   000c73 fb                   		ei
  1953   000c74 e1                   		pop	hl
  1954   000c75 114300               		ld	de, 0043h
  1955   000c78 c36c06               		jp	siowrite
  1956   000c7b cd4a0c               		call	sendack
  1957   000c7e cdb906               		call	sioread
  1958   000c81 c0                   		ret	nz
  1959                          
  1960   000c82 cd9cfc               		call	0fc9ch
  1961   000c85 b7                   		or	a
  1962   000c86 ed42                 		sbc	hl, bc
  1963   000c88 c0                   		ret	nz
  1964                          
  1965   000c89 c5                   		push	bc
  1966   000c8a cd4a0c               		call	sendack
  1967   000c8d c1                   		pop	bc
  1968   000c8e 2100c1               		ld	hl, 0c100h
  1969   000c91 ed5bb2fc             		ld	de, (0fcb2h)
  1970   000c95 f3                   		di
  1971   000c96 edb0                 		ldir
  1972   000c98 fb                   		ei
  1973   000c99 c354fc               		jp	0fc54h
  1974   000c9c 3afdc2               		ld	a, (0c2fdh)
  1975   000c9f 4f                   		ld	c, a
  1976   000ca0 0600                 		ld	b, 00h
  1977   000ca2 b7                   		or	a
  1978   000ca3 c0                   		ret	nz
  1979                          
  1980   000ca4 04                   		inc	b
  1981   000ca5 c9                   		ret
  1982                          
  1983   000ca6 cd4a0c               		call	sendack
  1984   000ca9 2afdc2               		ld	hl, (0c2fdh)
  1985   000cac 22b2fc               		ld	(0fcb2h), hl
  1986   000caf c354fc               		jp	0fc54h
  1987   000cb2 00                   		nop
  1988   000cb3 00                   		nop
  1989   000cb4 cd4a0c               		call	sendack
  1990   000cb7 cd54fc               		call	0fc54h
  1991   000cba 2afdc2               		ld	hl, (0c2fdh)
  1992   000cbd e9                   		jp	(hl)
  1993   000cbe af                   		xor	a
  1994   000cbf d356                 		out	(SETIDX), a
  1995   000cc1 3c                   		inc	a
  1996   000cc2 d354                 		out	(RESIDX), a
  1997   000cc4 3e0b                 		ld	a, 0bh
  1998   000cc6 cd6bf3               		call	0f36bh
  1999   000cc9 ee04                 		xor	04h
  2000   000ccb e684                 		and	84h
  2001   000ccd c29afd               		jp	nz, 0fd9ah
  2002   000cd0 2100c3               		ld	hl, 0c300h
  2003   000cd3 3abcff               		ld	a, (0ffbch)
  2004   000cd6 3c                   		inc	a
  2005   000cd7 47                   		ld	b, a
  2006   000cd8 3676            fcd8:		ld	(hl), 76h
  2007   000cda 23                   		inc	hl
  2008   000cdb 36ed                 		ld	(hl), 0edh
  2009   000cdd 23                   		inc	hl
  2010   000cde 36a3                 		ld	(hl), 0a3h
  2011   000ce0 23                   		inc	hl
  2012   000ce1 3620                 		ld	(hl), 20h
  2013   000ce3 23                   		inc	hl
  2014   000ce4 36fb                 		ld	(hl), 0fbh
  2015   000ce6 23                   		inc	hl
  2016   000ce7 10ef                 		djnz	fcd8		; (-11h)
  2017   000ce9 3ec9                 		ld	a, 0c9h
  2018   000ceb 77                   		ld	(hl), a
  2019   000cec 326600               		ld	(0066h), a
  2020   000cef 23                   		inc	hl
  2021   000cf0 22c3ff               		ld	(0ffc3h), hl
  2022   000cf3 af                   		xor	a
  2023   000cf4 322dff               		ld	(0ff2dh), a
  2024   000cf7 b7                   		or	a
  2025   000cf8 2805                 		jr	z, fcff		; (+05h)
  2026   000cfa 3e4b                 		ld	a, 4bh
  2027   000cfc cd6bf3               		call	0f36bh
  2028   000cff dd2ab6ff        fcff:		ld	ix, (0ffb6h)
  2029   000d03 fd2ab8ff             		ld	iy, (0ffb8h)
  2030   000d07 3abdff               		ld	a, (0ffbdh)
  2031   000d0a 1f                   		rra
  2032   000d0b 3a2fff               		ld	a, (0ff2fh)
  2033   000d0e 3007                 		jr	nc, fd17		; (+07h)
  2034   000d10 ee20                 		xor	20h
  2035   000d12 322fff               		ld	(0ff2fh), a
  2036   000d15 d330                 		out	(DISKCTRL), a
  2037   000d17 cda4fd          fd17:		call	0fda4h
  2038   000d1a 3a2dff               		ld	a, (0ff2dh)
  2039   000d1d d341                 		out	(FDCTRK), a
  2040   000d1f 2ac3ff               		ld	hl, (0ffc3h)
  2041   000d22 f3                   		di
  2042   000d23 3ef4                 		ld	a, 0f4h
  2043   000d25 cd89f3               		call	0f389h
  2044   000d28 3abbff               		ld	a, (0ffbbh)
  2045   000d2b 47                   		ld	b, a
  2046   000d2c 0e43                 		ld	c, 43h
  2047   000d2e cd00c3               		call	0c300h
  2048   000d31 fb                   		ei
  2049   000d32 db40            fd32:		in	a, (FDCSTAT)
  2050   000d34 cb47                 		bit	0, a
  2051   000d36 20fa                 		jr	nz, fd32		; (-06h)
  2052   000d38 ed5bbfff             		ld	de, (0ffbfh)
  2053   000d3c 2ac1ff               		ld	hl, (0ffc1h)
  2054   000d3f 3abaff               		ld	a, (0ffbah)
  2055   000d42 47                   		ld	b, a
  2056   000d43 dd2ab8ff             		ld	ix, (0ffb8h)
  2057   000d47 dd7e00          fd47:		ld	a, (ix+00h)
  2058   000d4a dd23                 		inc	ix
  2059   000d4c d342                 		out	(FDCSEC), a
  2060   000d4e 3a2fff               		ld	a, (0ff2fh)
  2061   000d51 e620                 		and	20h
  2062   000d53 3e88                 		ld	a, 88h
  2063   000d55 2802                 		jr	z, fd59		; (+02h)
  2064   000d57 cbcf                 		set	1, a
  2065   000d59 cd62f3          fd59:		call	0f362h
  2066   000d5c e698                 		and	98h
  2067   000d5e 2814                 		jr	z, fd74		; (+14h)
  2068   000d60 e680                 		and	80h
  2069   000d62 2036                 		jr	nz, fd9a		; (+36h)
  2070   000d64 e5                   		push	hl
  2071   000d65 c5                   		push	bc
  2072   000d66 01fdc2               		ld	bc, 0c2fdh
  2073   000d69 b7                   		or	a
  2074   000d6a ed42                 		sbc	hl, bc
  2075   000d6c c1                   		pop	bc
  2076   000d6d e1                   		pop	hl
  2077   000d6e 3004                 		jr	nc, fd74		; (+04h)
  2078   000d70 73                   		ld	(hl), e
  2079   000d71 23                   		inc	hl
  2080   000d72 72                   		ld	(hl), d
  2081   000d73 23                   		inc	hl
  2082   000d74 13              fd74:		inc	de
  2083   000d75 10d0                 		djnz	fd47		; (-30h)
  2084   000d77 ed53bfff             		ld	(0ffbfh), de
  2085   000d7b 22c1ff               		ld	(0ffc1h), hl
  2086   000d7e 3a2fff               		ld	a, (0ff2fh)
  2087   000d81 e620                 		and	20h
  2088   000d83 c2fffc               		jp	nz, 0fcffh
  2089   000d86 3a2dff               		ld	a, (0ff2dh)
  2090   000d89 3c                   		inc	a
  2091   000d8a 21beff               		ld	hl, 0ffbeh
  2092   000d8d be                   		cp	(hl)
  2093   000d8e daf4fc               		jp	c, 0fcf4h
  2094   000d91 2ac1ff               		ld	hl, (0ffc1h)
  2095   000d94 36ff                 		ld	(hl), 0ffh
  2096   000d96 23                   		inc	hl
  2097   000d97 36ff                 		ld	(hl), 0ffh
  2098   000d99 af                   		xor	a
  2099   000d9a f5              fd9a:		push	af
  2100   000d9b 3eff                 		ld	a, 0ffh
  2101   000d9d 322dff               		ld	(0ff2dh), a
  2102   000da0 d341                 		out	(FDCTRK), a
  2103   000da2 f1                   		pop	af
  2104   000da3 c9                   		ret
  2105                          
  2106   000da4 3abaff               		ld	a, (0ffbah)
  2107   000da7 4f                   		ld	c, a
  2108   000da8 dde5                 		push	ix
  2109   000daa e1                   		pop	hl
  2110   000dab 46                   		ld	b, (hl)
  2111   000dac 23                   		inc	hl
  2112   000dad ed5bc3ff             		ld	de, (0ffc3h)
  2113   000db1 cd0bfe          fdb1:		call	0fe0bh
  2114   000db4 10fb                 		djnz	fdb1		; (-05h)
  2115   000db6 46                   		ld	b, (hl)
  2116   000db7 23                   		inc	hl
  2117   000db8 e5                   		push	hl
  2118   000db9 dde1                 		pop	ix
  2119   000dbb 3a2dff          fdbb:		ld	a, (0ff2dh)
  2120   000dbe dd7707               		ld	(ix+07h), a
  2121   000dc1 3a2fff               		ld	a, (0ff2fh)
  2122   000dc4 e620                 		and	20h
  2123   000dc6 3e00                 		ld	a, 00h
  2124   000dc8 2801                 		jr	z, fdcb		; (+01h)
  2125   000dca 3c                   		inc	a
  2126   000dcb dd7709          fdcb:		ld	(ix+09h), a
  2127   000dce fd7e00               		ld	a, (iy+00h)
  2128   000dd1 fd23                 		inc	iy
  2129   000dd3 dd770b               		ld	(ix+0bh), a
  2130   000dd6 dde5                 		push	ix
  2131   000dd8 e1                   		pop	hl
  2132   000dd9 c5                   		push	bc
  2133   000dda cd0bfe          fdda:		call	0fe0bh
  2134   000ddd 10fb                 		djnz	fdda		; (-05h)
  2135   000ddf dd7e0d               		ld	a, (ix+0dh)
  2136   000de2 cdcdfa               		call	0facdh
  2137   000de5 3eff            fde5:		ld	a, 0ffh
  2138   000de7 12                   		ld	(de), a
  2139   000de8 13                   		inc	de
  2140   000de9 0b                   		dec	bc
  2141   000dea 78                   		ld	a, b
  2142   000deb b1                   		or	c
  2143   000dec 20f7                 		jr	nz, fde5		; (-09h)
  2144   000dee 46                   		ld	b, (hl)
  2145   000def 23                   		inc	hl
  2146   000df0 cd0bfe          fdf0:		call	0fe0bh
  2147   000df3 10fb                 		djnz	fdf0		; (-05h)
  2148   000df5 c1                   		pop	bc
  2149   000df6 0d                   		dec	c
  2150   000df7 20c2                 		jr	nz, fdbb		; (-3eh)
  2151   000df9 2ac3ff               		ld	hl, (0ffc3h)
  2152   000dfc 01d827               		ld	bc, 27d8h
  2153   000dff 09                   		add	hl, bc
  2154   000e00 ed52                 		sbc	hl, de
  2155   000e02 44                   		ld	b, h
  2156   000e03 4d                   		ld	c, l
  2157   000e04 62                   		ld	h, d
  2158   000e05 6b                   		ld	l, e
  2159   000e06 13                   		inc	de
  2160   000e07 77                   		ld	(hl), a
  2161   000e08 edb0                 		ldir
  2162   000e0a c9                   		ret
  2163                          
  2164   000e0b c5                   		push	bc
  2165   000e0c 46                   		ld	b, (hl)
  2166   000e0d 23                   		inc	hl
  2167   000e0e 7e                   		ld	a, (hl)
  2168   000e0f 23                   		inc	hl
  2169   000e10 12              fe10:		ld	(de), a
  2170   000e11 13                   		inc	de
  2171   000e12 10fc                 		djnz	fe10		; (-04h)
  2172   000e14 c1                   		pop	bc
  2173   000e15 c9                   		ret
  2174                          
  2175   000e16 0110ff               		ld	bc, TC0INTVEC
  2176   000e19 0b                   		dec	bc
  2177   000e1a 03                   		inc	bc
  2178   000e1b 00                   		nop
  2179   000e1c 03                   		inc	bc
  2180   000e1d 00                   		nop
  2181   000e1e 01fe01               		ld	bc, 01feh
  2182   000e21 00                   		nop
  2183   000e22 010001               		ld	bc, 0100h
  2184   000e25 00                   		nop
  2185   000e26 010001               		ld	bc, 0100h
  2186   000e29 f7                   		rst	30h
  2187   000e2a 0b                   		dec	bc
  2188   000e2b ff                   		rst	38h
  2189   000e2c 0600                 		ld	b, 00h
  2190   000e2e 01fb02               		ld	bc, 02fbh
  2191   000e31 01f709               		ld	bc, 09f7h
  2192   000e34 ff                   		rst	38h
  2193   000e35 01204e               		ld	bc, 4e20h
  2194   000e38 0c                   		inc	c
  2195   000e39 0c                   		inc	c
  2196   000e3a 00                   		nop
  2197   000e3b 03                   		inc	bc
  2198   000e3c f5                   		push	af
  2199   000e3d 01fe01               		ld	bc, 01feh
  2200   000e40 00                   		nop
  2201   000e41 010001               		ld	bc, 0100h
  2202   000e44 00                   		nop
  2203   000e45 010101               		ld	bc, 0101h
  2204   000e48 f7                   		rst	30h
  2205   000e49 164e                 		ld	d, 4eh
  2206   000e4b 0c                   		inc	c
  2207   000e4c 00                   		nop
  2208   000e4d 03                   		inc	bc
  2209   000e4e f5                   		push	af
  2210   000e4f 01fb02               		ld	bc, 02fbh
  2211   000e52 01f710               		ld	bc, 10f7h
  2212   000e55 4e                   		ld	c, (hl)
  2213   000e56 12                   		ld	(de), a
  2214   000e57 100e                 		djnz	fe67		; (+0eh)
  2215   000e59 0c                   		inc	c
  2216   000e5a 0a                   		ld	a, (bc)
  2217   000e5b 08                   		ex	af, af'
  2218   000e5c 0604                 		ld	b, 04h
  2219   000e5e 02                   		ld	(bc), a
  2220   000e5f 110f0d               		ld	de, 0d0fh
  2221   000e62 0b                   		dec	bc
  2222   000e63 09                   		add	hl, bc
  2223   000e64 07                   		rlca
  2224   000e65 05                   		dec	b
  2225   000e66 03                   		inc	bc
  2226   000e67 010107          fe67:		ld	bc, 0701h
  2227   000e6a 0d                   		dec	c
  2228   000e6b 060c                 		ld	b, 0ch
  2229   000e6d 12                   		ld	(de), a
  2230   000e6e 05                   		dec	b
  2231   000e6f 0b                   		dec	bc
  2232   000e70 11040a               		ld	de, 0a04h
  2233   000e73 1003                 		djnz	fe78		; (+03h)
  2234   000e75 09                   		add	hl, bc
  2235   000e76 0f                   		rrca
  2236   000e77 02                   		ld	(bc), a
  2237   000e78 08              fe78:		ex	af, af'
  2238   000e79 0e04                 		ld	c, 04h
  2239   000e7b 28ff                 		jr	z, ASMPC+1		; (-01h)
  2240   000e7d 0600                 		ld	b, 00h
  2241   000e7f 01fc1a               		ld	bc, 1afch
  2242   000e82 ff                   		rst	38h
  2243   000e83 0b                   		dec	bc
  2244   000e84 03                   		inc	bc
  2245   000e85 00                   		nop
  2246   000e86 03                   		inc	bc
  2247   000e87 00                   		nop
  2248   000e88 01fe01               		ld	bc, 01feh
  2249   000e8b 00                   		nop
  2250   000e8c 010001               		ld	bc, 0100h
  2251   000e8f 00                   		nop
  2252   000e90 010001               		ld	bc, 0100h
  2253   000e93 f7                   		rst	30h
  2254   000e94 0b                   		dec	bc
  2255   000e95 ff                   		rst	38h
  2256   000e96 0600                 		ld	b, 00h
  2257   000e98 01fb02               		ld	bc, 02fbh
  2258   000e9b 01f71b               		ld	bc, 1bf7h
  2259   000e9e ff                   		rst	38h
  2260   000e9f 05                   		dec	b
  2261   000ea0 50                   		ld	d, b
  2262   000ea1 4e                   		ld	c, (hl)
  2263   000ea2 0c                   		inc	c
  2264   000ea3 00                   		nop
  2265   000ea4 03                   		inc	bc
  2266   000ea5 f601                 		or	01h
  2267   000ea7 fc324e               		call	m, 4e32h
  2268   000eaa 0c                   		inc	c
  2269   000eab 0c                   		inc	c
  2270   000eac 00                   		nop
  2271   000ead 03                   		inc	bc
  2272   000eae f5                   		push	af
  2273   000eaf 01fe01               		ld	bc, 01feh
  2274   000eb2 00                   		nop
  2275   000eb3 010001               		ld	bc, 0100h
  2276   000eb6 00                   		nop
  2277   000eb7 010101               		ld	bc, 0101h
  2278   000eba f7                   		rst	30h
  2279   000ebb 164e                 		ld	d, 4eh
  2280   000ebd 0c                   		inc	c
  2281   000ebe 00                   		nop
  2282   000ebf 03                   		inc	bc
  2283   000ec0 f5                   		push	af
  2284   000ec1 01fb02               		ld	bc, 02fbh
  2285   000ec4 01f735               		ld	bc, 35f7h
  2286   000ec7 4e                   		ld	c, (hl)
  2287   000ec8 010e03               		ld	bc, 030eh
  2288   000ecb 1005                 		djnz	ASMPC + 2 + 5	;(+05h)
  2289   000ecd 12                   		ld	(de), a
  2290   000ece 07                   		rlca
  2291   000ecf 14                   		inc	d
  2292   000ed0 09                   		add	hl, bc
  2293   000ed1 160b                 		ld	d, 0bh
  2294   000ed3 180d                 		jr	fee2		; (+0dh)
  2295   000ed5 1a                   		ld	a, (de)
  2296   000ed6 02                   		ld	(bc), a
  2297   000ed7 0f                   		rrca
  2298   000ed8 04                   		inc	b
  2299   000ed9 110613               		ld	de, 1306h
  2300   000edc 08                   		ex	af, af'
  2301   000edd 15                   		dec	d
  2302   000ede 0a                   		ld	a, (bc)
  2303   000edf 17                   		rla
  2304   000ee0 0c                   		inc	c
  2305   000ee1 19                   		add	hl, de
  2306   000ee2 011209          fee2:		ld	bc, 0912h
  2307   000ee5 1a                   		ld	a, (de)
  2308   000ee6 110819               		ld	de, 1908h
  2309   000ee9 1007                 		djnz	ASMPC + 2 + 7	; (+07h)
  2310   000eeb 180f                 		jr	ASMPC + 2 + 15	; (+0fh)
  2311   000eed 0617                 		ld	b, 17h
  2312   000eef 0e05                 		ld	c, 05h
  2313   000ef1 160d                 		ld	d, 0dh
  2314   000ef3 04                   		inc	b
  2315   000ef4 15                   		dec	d
  2316   000ef5 0c                   		inc	c
  2317   000ef6 03                   		inc	bc
  2318   000ef7 14                   		inc	d
  2319   000ef8 0b                   		dec	bc
  2320   000ef9 02                   		ld	(bc), a
  2321   000efa 13                   		inc	de
  2322   000efb 0a                   		ld	a, (bc)
  2323                          
  2324                          ;		dw	0, 0
  2325                          ;--------------------------------------------------
  2326                          ; Workarea (Const + Vars) copied from ROM
  2327                          ;--------------------------------------------------
  2328                          ;ff00:		dw	0, 0, 0, 0			;16-byte receive buffer
  2329                          ;		dw	0, 0, 0, 0
  2330                          ;ff10:		dw	0, 0, 0, 0			;CTC interrup vectors
  2331                          ;		dw	0, 0, 0, 0
  2332                          
  2333   000efc ffffffff00000000ff20:		db	0FFh, 0FFh, 0FFh, 0FFh, 000h, 000h, 000h, 000h
  2334   000f04 1010101000ff0100		db	010h, 010h, 010h, 010h, 000h, 0FFh, 001h, 000h
  2335   000f0c 0000320a00000000		db	000h, 000h, 032h, 00Ah, 000h, 000h, 000h, 000h
  2336   000f14 2108            ff38:		dw	devicetab
  2337   000f16 be07            ff3a:		dw	sioidle
  2338   000f18 e107            ff3c:		dw	return
  2339   000f1a 020d            ff3e:		db	002h, 00Dh
  2340   000f1c 0a000000003c0080		db	00Ah, 000h, 000h, 000h, 000h, 03Ch, 000h, 080h
  2341   000f24 00b7fb00c5ff0f  		db	000h, 0B7h, 0FBh, 000h, 0C5h, 0FFh, 00Fh
  2342                          
  2343                          ;--------------------------------------------------
  2344                          ; set to zero in startup code until 0ffffh
  2345                          ;--------------------------------------------------
  2346   000f2b 73              ff2a:		db	73h
  2347   000f2c 00                   		nop
  2348   000f2d 00                   		nop
  2349   000f2e 00                   		nop
  2350   000f2f 00                   		nop
  2351   000f30 00                   		nop
  2352   000f31 00                   		nop
  2353   000f32 00                   		nop
  2354   000f33 00              ff33:     	nop
  2355   000f34 00                   		nop
  2356   000f35 00                   		nop
  2357   000f36 00                   		nop
  2358   000f37 53414c4c59203120		db	"SALLY 1 Rev 1.01"
                52657620312e3031
  2359                          
