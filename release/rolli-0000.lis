rolli-0000.asm:
     1                          
     2                          RIDCMD		equ	11000000B	;READ ID COMMAND
     3                          RDCMD		equ	10000000B	;READ COMMAND
     4                          WRTCMD		equ	10100000B	;WRITE COMMAND
     5                          FINCMD		equ	11010000B	;FORCE INTERRUPT COMMAND
     6                          SKCMD		equ	00010000B	;SEEK COMMAND
     7                          RSTCMD		equ	00000000B	;RESTORE COMMAND
     8                          STEPOUT		equ	01100000B	;STEP OUT COMMAND
     9                          STEPIN		equ	01000000B	;STEP IN COMMAND
    10                          HLOAD		equ	00000000B	;HEAD LOAD BIT FOR TYPE 1 COMMANDS
    11                          
    12                          ;
    13                          ;	... DATA STRUCTURE FOR DISK I/O CONTROL BLOCK ...
    14                          ;
    15                          DSKOP		equ	0		;DISK OPERATION CODE
    16                          DSKDRV		equ	1		;DRIVE# (WITH SIDE# IN BIT 7)
    17                          DSKTRK		equ	2		;TRACK#
    18                          DSKSEC		equ	3		;SECTOR#
    19                          DSKPTR		equ	4		;READ/WRITE POINTER
    20                          DSKAUX		equ	6		;AUXILLIARY PARAMETERS (2 BYTES)
    21                          DSKSTS		equ	8		;OPERATION COMPLETION STATUS
    22                          
    23                          putaddr		equ	0f493h
    24                          puthex		equ	0f498h
    25                          coninit		equ	0f5fch
    26                          conin		equ	0f640h
    27                          conout		equ	0f650h
    28                          SELECT		equ	0f110h
    29                          RESTORE		equ	0f23bh
    30                          SEEKTRK		equ	0f1fch
    31                          RWDISK		equ	0f2b6h
    32                          RENEW		equ	0f018h
    33                          WATCHDOG	equ	0f3a8h
    34                          RECOVER		equ	0f30fh
    35                          ACTIVON		equ	0f03ch
    36                          
    37                          dskhandler	equ	0f00fh
    38                          CFRAME		equ	IOBUFF+LEN-5
    39                          iobuflenhi	equ	(IOBUFF+LEN) / 256
    40                          
    41                          
    42                          		include "equs.mac"
equs.mac:
     1                          KEYBUF		equ	0ff00h		;16 byte keyboard input fifo
     2                          CTCVEC		equ	0ff10h		;8 word interrupt vector table
     3                          ;
     4                          ;
     5                          ;
     6                          PRINTER		equ	020h		;PRINTER OUTPUT/INPUTS
     7                          LATCH		equ	030h		;DRIVE CONTROL LATCH
     8                          WD179X		equ	040h		;WD TYPE DISK CONTROLLER
     9                          ;
    10                          ;	EQUATES FOR DISK CONTROLLER PORTS AND COMMAND CODES
    11                          ;
    12                          STSREG		equ	WD179X+0	;STATUS REGISTER
    13                          CMDREG		equ	WD179X+0	;COMMAND REGISTER
    14                          TRKREG		equ	WD179X+1	;TRACK REGISTER
    15                          SECREG		equ	WD179X+2	;SECTOR REGISTER
    16                          DATREG		equ	WD179X+3	;DATA REGISTER;
    17                          
    18                          SERIN		equ	050h		;RS232 SERIAL INPUT
    19                          ;
    20                          ATROUT		equ	050h		;ATARI SERIAL OUTPUT
    21                          SEROUT		equ	051h		;RS232 SERIAL OUTPUT
    22                          BANKSW		equ	052h		;ROM BANKSWITCH BIT
    23                          STROBE		equ	053h		;PRINTER STROBE
    24                          INDXCLR		equ	054h		;INDEX CONTROL FLOP CLEAR
    25                          DTR		equ	055h		;DTR OUTPUT CONTROL
    26                          INDXSET		equ	056h		;INDEX CONTROL FLOP SET
    27                          CDMUX		equ	057h		;ATARI CMD/DATA MUX CONTROL
    28                          ;
    29                          ATARI		equ	070h		;ATARI INPUT BITS PORT
    30                          CTC0		equ	080h		;ZILOG COUNTER/TIMER
    31                          CTC1		equ	081h
    32                          CTC2		equ	082h
    33                          CTC3		equ	083h
    34                          ;
    35                          NULL		equ	000h
    36                          CR		equ	00dh
    37                          LF		equ	00ah
    38                          ;
    39                          
rolli-0000.asm:
    43                          		include "global.mac"
global.mac:
     1                          ;********************************************************
     2                          ;*							*
     3                          ;*	GLOBAL VARIABLES FOR ATARI Z80 ROM		*
     4                          ;*							*
     5                          ;********************************************************
     6                          ;
     7                          glbvars	equ	0ff20h
     8                          ;
     9                          ;	... GLOBAL VARIABLES FOR PHYSICAL DISK HANDLER ...
    10                          ;
    11                          ;DRVTAB:	DEFB	255,255,255,255	;HEAD POSITIONS FOR 4 DRIVES
    12                          ;		DEFB	0,0,0,0		;DENSITY/TYPE/SELECT BITS FOR 4 DRIVES
    13                          ;RATES:		DEFB	16,16,16,16	;SETTLING DELAYS / STEP RATES TABLE
    14                          ;UNIT:		DEFB	0		;CURRENTLY SELECTED DISK#
    15                          ;TRACK:		DEFB	255		;TRACK POSITION OF SELECTED DRIVE
    16                          ;DRVOFF:	DEFB	1		;DRIVES-OFF FLAG FROM DISK TIMER IRQ
    17                          ;OUTCPY:	DEFB	00000000B	;COPY OF DISK CONTROL LATCH
    18                          ;PERIOD:	DEFW	0		;DISK SPIN PERIOD
    19                          ;HLDTIM:	DEFB	50		;HEAD LOAD DELAY
    20                          ;RWMAX:		DEFB	10		;MAX NUMBER OF READ/WRITE RETRIES
    21                          ;		DEFB	0,0,0,0		;ROOM FOR EXPANSION
    22                          
    23                          DRVTAB:		equ	glbvars		;HEAD POSITIONS FOR 4 DRIVES
    24                          					;DENSITY/TYPE/SELECT BITS FOR 4 DRIVES
    25                          RATES:		equ	DRVTAB+8	;SETTLING DELAYS / STEP RATES TABLE
    26                          UNIT:		equ	RATES+4		;CURRENTLY SELECTED DISK#
    27                          TRACK:		equ	UNIT+1		;TRACK POSITION OF SELECTED DRIVE
    28                          DRVOFF:		equ	TRACK+1		;DRIVES-OFF FLAG FROM DISK TIMER IRQ
    29                          OUTCPY:		equ 	DRVOFF+1	;COPY OF DISK CONTROL LATCH
    30                          PERIOD:		equ	OUTCPY+1	;DISK SPIN PERIOD
    31                          HLDTIM:		equ	PERIOD+2	;HEAD LOAD DELAY
    32                          RWMAX:		equ	HLDTIM+1	;MAX NUMBER OF READ/WRITE RETRIES
    33                          EXPANSION	equ	RWMAX+1		;ROOM FOR EXPANSION
    34                          ;
    35                          ;
    36                          ;	... GLOBAL VARIABLES FOR ATARI HANDLER ...
    37                          ;
    38                          ;IDPTR:		DEFW	IDTAB		;POINTER TO DEVICE ID TABLE
    39                          ;FSMVEC:	DEFW	PWRWAIT		;POINTER FOR ATARI TASK STATE MACHINE
    40                          ;EXTVEC:	DEFW	DUMMY		;POINTER FOR EXTRA TASK PROCESSOR
    41                          ;NEWLIN:	DEFB	2,CR,LF,0,0	;PRINTER NEWLINE CHARACTERS
    42                          ;PSMSG:		DEFB	0,0,60,0	;PRINTER STATUS FRAME
    43                          ;PMASKS:	DEFB	10000000B	;MASK ALL BITS BUT 'BUSY'
    44                          ;		DEFB	00000000B	;COMPARE TO ZERO FOR READY
    45                          ;FMTPTR:	DEFW	FMTS		;POINTER TO STANDARD FORMAT TABLES
    46                          ;PBASE:		DEFW	IOBUFF+(2*LEN)	;PUT PRINT BUFFER AFTER HERE
    47                          ;PSIZE:		DEFW	4095		;MAX BUFFER INDEX OFFSET
    48                          ;
    49                          ;glbsize	equ	$-glbvars		;length of initialized variables
    50                          ;        DEFB    73h			; **** Exists in original ROM? ****
    51                          IDPTR:		equ	EXPANSION+4	;POINTER TO DEVICE ID TABLE
    52                          FSMVEC:		equ 	IDPTR+2		;POINTER FOR ATARI TASK STATE MACHINE
    53                          EXTVEC:		equ	FSMVEC+2	;POINTER FOR EXTRA TASK PROCESSOR
    54                          NEWLIN:		equ	EXTVEC+2	;PRINTER NEWLINE CHARACTERS
    55                          PSMSG:		equ	NEWLIN+5	;PRINTER STATUS FRAME
    56                          PMASKS:		equ	PSMSG+4		;MASK ALL BITS BUT 'BUSY'
    57                          					;COMPARE TO ZERO FOR READY
    58                          FMTPTR:		equ	PMASKS+2	;POINTER TO STANDARD FORMAT TABLES
    59                          PBASE:		equ	FMTPTR+2	;PUT PRINT BUFFER AFTER HERE
    60                          PSIZE:		equ	PBASE+2		;MAX BUFFER INDEX OFFSET
    61                          
    62                          glbsize	equ	$-glbvars		;length of initialized variables
    63                          ;
    64                          ;
    65                          ;	*** UNINITIALIZED SCRATCH VARIABLES COME AFTER HERE ***
    66                          ;
    67                          PCOUNT:		EQU 	PSIZE+2		;BYTECOUNT FOR BUFFER
    68                          PINP:		EQU 	PCOUNT+2	;INPUT OFFSET
    69                          POUT:		EQU 	PINP+2		;OUTPUT OFFSET
    70                          CMDFLG:		EQU 	POUT+2		;COMMAND FRAME READY FLAG FROM IRQ
    71                          DMATRIX:	EQU 	CMDFLG+1    	;DRIVE POOP TABLES
    72                          OLDPTR:		EQU 	DMATRIX+64	;POINTER TO FIRST DRIVE ACCESSED
    73                          DKIOCB:		EQU 	OLDPTR+2	;DISK I/O COMMAND BLOCK
    74                          DRWCMD:		EQU 	DKIOCB+16	;R/W COMMAND FROM ATARI TO 'DISKIO'
    75                          LOGSIZ:		EQU 	DRWCMD+1	;LOGICAL SECTOR LENGTH FOR XFER
    76                          IDBUF:		EQU	LOGSIZ+2	;BUFFER FOR ID MARK READS
    77                          IOPTR:		EQU 	IDBUF+8		;ATARI BLOCK INPUT POINTER
    78                          VFLAG:		EQU 	IOPTR+2		;VERIFY FLAG FOR DISK WRITES
    79                          
    80                          ;
    81                          ;
    82                          ;	... VARIABLES FOR DISK FORMAT FUNCTION ...
    83                          ;
    84                          FMTSTUFF	EQU	VFLAG+1
    85                          FRMPTR:		EQU 	VFLAG+1			;POINTER TO FORMAT DATA TABLE
    86                          SKWPTR:		EQU 	FRMPTR+2		;POINTER TO SKEW TABLE
    87                          NSECTS:		EQU 	SKWPTR+2		;NUMBER OF SECTORS
    88                          TRKSIZ:		EQU 	NSECTS+1		;TRACK LENGTH IN BYTES
    89                          FMTLEN		EQU	(TRKSIZ+2)-FMTSTUFF
    90                          
    91                          sides:		EQU 	TRKSIZ+2		;copy of 'nsides' for drive#
    92                          tracks:		EQU 	sides+1			;copy of 'ntrks' for drive#
    93                          SEQNUM:		EQU 	tracks+1		;TEMP SECTOR SEQUENCE NUMBER
    94                          SEQPTR:		EQU 	SEQNUM+2		;TEMP ERROR LOG TABLE POINTER
    95                          TRKPTR:		EQU 	SEQPTR+2		;POINTER TO START OF TRACK IMAGE
    96                          
    97                          ;
    98                          ;	... LOCAL VARIABLES FOR DISK HANDLER ...
    99                          ;
   100                          CMDBYT:		EQU 	TRKPTR+2		;COMMAND BYTE FOR READS/WRITES
   101                          RWTRY:		EQU	CMDBYT+1		;READ/WRITE RETRY COUNT
   102                          TICKS:		EQU	RWTRY+1			;FREE RUNNING MILISECOND COUNTER
   103                          DRVTMR:		EQU	TICKS+2			;DISK ACTIVITY TIMER
   104                          ;
   105                          ;
   106                          ;
   107                          ;
   108                          IOBUFF	EQU	0C100H		;ATARI I/O BUFFER
   109                          LEN	EQU	512
   110                          ;
   111                          TRKBUF	EQU	IOBUFF+LEN	;TRACK BUFFER FOR READS
   112                          ;
   113                          
rolli-0000.asm:
    44                          
    45                          ;--------------------------------------------------
    46                          ; Code executed after Reset
    47                          ;--------------------------------------------------
    48                          		ORG	00000h
    49   000000 c31500          		jp	reset
    50   000003 c3ed01          		jp	serin
    51   000006 c3cf01          		jp	serout
    52   000009 c3b601          		jp	serhex
    53   00000c c38d01          		jp	sercmd
    54   00000f c35f01          		jp	serdump
    55   000012 c32301          		jp	serrecv
    56                          ;
    57   000015 f3              reset:		di      				;disable interrupt
    58   000016 af              		xor     a				;set a to zero
    59   000017 3d              restime:	dec     a				;do 256 times nothing
    60   000018 20fd            		jr      nz, restime			;loop
    61                          
    62   00001a 21f300          		ld      hl, portval			;init 11 ports with values at 0a3h
    63   00001d 060b            		ld      b, 0bh
    64   00001f 4e              portinit:	ld      c, (hl)
    65   000020 23              		inc     hl
    66   000021 eda3            		outi
    67   000023 20fa            		jr      nz, portinit			; loop
    68                          
    69                          
    70   000025 2100f0          		ld      hl,0f000h          		;test ram @F000-FFFF
    71   000028 3e01            		ld      a, 01h             		;write 1,2,4,8,16,32,64,128
    72   00002a 0610            testram2:	ld      b, 10h
    73   00002c 77              testram:	ld      (hl),a
    74   00002d 07              		rlca
    75   00002e 2c              		inc     l
    76   00002f 20fb            		jr      nz, testram
    77   000031 24              		inc     h
    78   000032 10f8            		djnz    testram
    79                          
    80   000034 0e10            		ld      c, 10h
    81   000036 2b              testram1:	dec     hl
    82   000037 0f              		rrca
    83   000038 be              		cp      (hl)
    84   000039 20fe            ramerr:		jr      nz, ramerr			;if error, loop forever
    85   00003b 10f9            		djnz    testram1
    86   00003d 0d              		dec     c
    87   00003e 20f6            		jr      nz, testram1
    88   000040 87              		add     a, a
    89   000041 20e7            		jr      nz, testram2
    90                          
    91   000043 213c02          		ld      hl, sallycode			;copy BIOS 0f000h
    92   000046 1100f0          		ld      de, 0f000h			;length always 0f00h
    93   000049 01000f          		ld      bc, 00f00h
    94   00004c edb0            		ldir
    95   00004e 213811          		ld      hl, sallycode+0efch		;copy initial values to 0ff20h
    96   000051 1120ff          		ld      de, 0ff20h			;length $2F
    97   000054 012f00          		ld      bc, 002fh
    98   000057 edb0            		ldir
    99                          
   100   000059 af              		xor     a				;fill up to $FFFF with zeros
   101   00005a 12              ramfill:	ld      (de),a
   102   00005b 1c              		inc     e
   103   00005c 20fc            		jr      nz, ramfill
   104                          
   105   00005e 3110ff          		ld      sp, 0ff10h			;stack-pointer to 0ff10h
   106                          
   107   000061 3eff            		ld      a, 0ffh				;load interrupt-vector register
   108   000063 ed47            		ld      i, a				;with 0ffh
   109   000065 ed5e            		im      2				;enable interrupt mode 2 (vectored)
   110                          
   111                          ;--------------------------------------------------
   112                          ; step 5 times in and then out to trk00
   113                          ; set bit 6 for each online floppy in ff5eh
   114                          ; percom block (16 bytes, byte 8 bit 6)
   115                          ;--------------------------------------------------
   116   000067 3e4f            		ld      a, 4fh				;select drive 1-4, Motor off, side 0, B/S=1, DD
   117   000069 d330            		out     (LATCH),a
   118                          
   119   00006b 57              		ld      d, a				;d = 4fh
   120   00006c 0605            		ld      b, 5				;step 5 times
   121                          stepin:
   122   00006e 3e49            		ld      a, 49h				;4b = 0100 1011 = step-in
   123   000070 cde500          		call    CMDOUT				;write A to FDC command and wait
   124   000073 10f9            		djnz    stepin
   125                          
   126   000075 0664            		ld      b, 64h				;seek track 00 for all 4 drives
   127   000077 7a              outloop1:	ld      a, d				;select all drives
   128   000078 d330            		out     (LATCH),a
   129   00007a e3              		ex      (sp),hl				;???
   130   00007b e3              		ex      (sp),hl				;???
   131   00007c 3e69            		ld      a, 69h				;step out
   132   00007e cde500          		call    CMDOUT				;write A to FDC command and wait
   133                          
   134   000081 1e01            		ld      e, 01h
   135   000083 7b              outloop:	ld      a, e
   136   000084 f640            		or      40h
   137   000086 d330            		out     (LATCH), a			;select one drive
   138   000088 e3              		ex      (sp), hl
   139   000089 e3              		ex      (sp), hl
   140                          ;		call    0f391h				;stop command, get status
   141   00008a db40            		in	a, (STSREG)
   142   00008c cb57            		bit     2, a
   143   00008e 2804            		jr      z, excldrv			;bit not set, not at track 00
   144   000090 7b              		ld      a, e				;drive at track 00
   145   000091 2f              		cpl     				;exclude drive from seeking
   146   000092 a2              		and     d
   147   000093 57              		ld      d, a
   148                          excldrv:
   149   000094 cb23            		sla     e
   150   000096 cb63            		bit     4, e
   151   000098 28e9            		jr      z, outloop			;status checked for all 4 drives?
   152   00009a 10db            		djnz    outloop1			;step out again
   153                          
   154                          ;		call    0f068h				;deselect floppies and seek current track?
   155   00009c 3e50            		ld	a, 50h				;reset FDC and deselct
   156   00009e d330            		out	(LATCH), a
   157   0000a0 3e40            		ld	a, 40h				;reset FDC and deselct
   158   0000a2 d330            		out	(LATCH), a
   159                          
   160   0000a4 215eff          		ld      hl, 0ff5eh			;set bit for each connected floppy?
   161   0000a7 011000          		ld      bc, 0010h
   162   0000aa 3e04            		ld      a, 04h
   163   0000ac cb1a            nextdrv:	rr      d
   164   0000ae 3802            		jr      c, noset
   165   0000b0 cbf6            		set     6, (hl)
   166   0000b2 09              noset:		add     hl, bc
   167   0000b3 3d              		dec     a
   168   0000b4 20f6            		jr      nz, nextdrv
   169                          
   170                          
   171   0000b6 210000          		ld	hl, 00000h			; source
   172   0000b9 110080          		ld	de, 08000h			; dest
   173   0000bc 010020          		ld	bc, 02000h
   174   0000bf edb0            		ldir
   175   0000c1 21c700          		ld	hl, code8000
   176   0000c4 cbfc            		set	7, h
   177   0000c6 e9              		jp	(hl)
   178   0000c7 3e01            code8000:	ld	a, 1
   179   0000c9 d352            		out	(BANKSW), a
   180   0000cb 210080          		ld	hl, 08000h
   181   0000ce 110000          		ld	de, 00000h
   182   0000d1 010020          		ld	bc, 02000h
   183   0000d4 edb0            		ldir
   184   0000d6 c3d900          		jp	code0000
   185                          
   186                          code0000:
   187   0000d9 3100c1          		ld      sp, 0c100h			;set stack to 0c100h
   188   0000dc cdae01          		call	sercr
   189   0000df cdae01          		call	sercr
   190   0000e2 c362f7          		jp      0f762h				;jump to code in DRAM
   191                          ;		jp	0f003h
   192                          ;		jp	main
   193                          
   194                          CMDOUT:
   195   0000e5 d340            		OUT	(CMDREG),A			;OUTPUT DISK CONTROLLER COMMAND BYTE
   196   0000e7 3e0e            CMDT1:		LD	A,14
   197   0000e9 3d              CMDT2:		DEC	A
   198   0000ea 20fd            		JR	NZ,CMDT2			;DELAY 56 MICROSECONDS
   199   0000ec db40            CMDT3:		in	a, (STSREG)
   200   0000ee cb47            		bit	0, a
   201   0000f0 20fa            		jr	nz, CMDT3
   202   0000f2 c9              		RET
   203                          
   204                          ;--------------------------------------------------
   205                          ; 11 times port:value
   206                          ;--------------------------------------------------
   207   0000f3 5001            portval:	db	050h, 001h			;Bit0	set ATARI DATA
   208   0000f5 5101            		db	051h, 001h			;Bit1	set RS232 TX
   209   0000f7 8003            		db	080h, 003h			;CTC	Channel 0 reset
   210   0000f9 8010            		db 	080h, 010h			;CTC	Channel 0 interrupt vector
   211   0000fb 8107            		db	081h, 007h			;CTC	Channel 1 reset + set time constant
   212   0000fd 8101            		db	081h, 001h			;CTC	Channel 1 time contant
   213   0000ff 8203            		db	082h, 003h			;CTC	Channel 2 reset
   214   000101 8303            		db	083h, 003h			;CTC	Channel 3 reset
   215   000103 5701            		db	057h, 001h			;Bit7	ATARI RXD
   216   000105 3050            		db	030h, 050h			;DRIVE CONTROL reset FDC
   217   000107 3040            		db	030h, 040h			;DRIVE CONTROL 8Mhz
   218                          
   219                          main:
   220                          		;call	0f5fch				;coninit
   221                          
   222   000109 21fbc2          serloop1:	ld	hl, IOBUFF+LEN-5
   223   00010c cd2301          serloop:	call	serrecv
   224   00010f 28fb            		jr	z, serloop
   225   000111 cd8d01          		call	sercmd
   226   000114 cd54fc          		call	0fc54h
   227                          
   228   000117 2100c1          		ld	hl, IOBUFF
   229   00011a cd2301          		call	serrecv
   230   00011d cd5f01          		call	serdump
   231                          
   232   000120 c30901          		jp	main
   233                          ;
   234                          ;
   235                          ; 19200 = 208 cycles
   236                          ;
   237                          serrecv:
   238                          ;	LD	DE,2730		;SET ABORT COUNTER FOR 32 MILLISECONDS
   239   000123 010000          	LD	BC,0		;CLEAR B/C FOR CHECKSUM DERRIVATION
   240   000126 1829            	JR	RXB35		;GO START LOOPING FOR START BIT
   241                          ;
   242   000128 79              RXB1:	LD	A,C		;4
   243   000129 80              	ADD	A,B		;4
   244   00012a ce00            	ADC	A,0		;7 ACCUMULATE CHECKSUM ATARI STYLE
   245   00012c 4f              	LD	C,A		;4
   246   00012d e3              	EX	(SP),HL		;19
   247   00012e e3              	EX	(SP),HL		;19
   248   00012f e3              	EX	(SP),HL		;19
   249   000130 e3              	EX	(SP),HL		;19
   250   000131 0608            	LD	B,8		;7	=102
   251                          ;
   252                          ;	SERIAL->PARALLEL CONVERSION AT 52 MICROSECONDS PER BIT
   253                          ;
   254   000133 3e0b            RXB2:	LD	A,11		;  7 CYCLES
   255   000135 3e0b            	LD	A,11		;  7 CYCLES
   256   000137 00              	NOP			;  4 CYCLES
   257   000138 3d              RXB3:	DEC	A		; 44 CYCLES  (11*4)
   258   000139 c23801          	JP	NZ,RXB3		;110 CYCLES  (11*10)
   259   00013c db70            	IN	A,(ATARI)	; 11 CYCLES
   260   00013e 17              	RLA			;  4 CYCLES
   261   00013f cb1a            	RR	D		;  8 CYCLES
   262   000141 10f0            	DJNZ	RXB2		; 13 CYCLES  (8 ON FINAL BIT)
   263                          
   264   000143 42              	LD	B,D		;4 SAVE COPY OF LAST DATA BYTE IN B
   265   000144 72              	LD	(HL),D		;7 THEN STORE IN MEMORY BUFFER @HL
   266   000145 23              	INC	HL		;6
   267   000146 7c              	LD	A,H		;4
   268   000147 fec3            	CP	iobuflenhi	;7
   269   000149 3f              	CCF			;4
   270   00014a d8              	RET	C		;5 RETURN WITH CARRY SET IF BUFFER FILLED
   271                          
   272   00014b 3e06            	ld	a, 6
   273   00014d 3d              rxb3a:	dec	a
   274   00014e c24d01          	jp	nz, rxb3a
   275                          
   276                          RXB35:	;LD	A,01000111B
   277                          	;OUT	(CTC0),A	;PUT CTC0 IN COUNTER MODE
   278                          	;XOR	A
   279                          	;OUT	(CTC0),A	;COUNT DATA HIGH->LOW EDGES MOD 256
   280                          
   281   000151 11a101          	LD	DE,417		;10 5 MILLISECONDS @ 12 MICROSECONDS/LOOP
   282   000154 db70            RXB4:	IN	A,(ATARI)
   283   000156 17              	RLA
   284   000157 30cf            	JR	NC,RXB1		;NEW BYTE IS COMING IF START BIT LOW
   285   000159 1b              	DEC	DE
   286   00015a 7a              	LD	A,D
   287   00015b b3              	OR	E
   288   00015c 20f6            	JR	NZ,RXB4		;ELSE LOOP TILL TIMER RUNS OUT
   289                          
   290   00015e c9              	RET			;RETURN WITH CARRY CLEAR IF TIMED OUT
   291                          ;--------------------------------------------------
   292                          ; RS232 dump
   293                          ;--------------------------------------------------
   294   00015f 1100c1          serdump:	ld	de, 0c100h
   295   000162 eb              		ex	de, hl
   296   000163 cdae01          		call	sercr
   297   000166 cd8d01          		call	sercmd
   298   000169 cdae01          		call	sercr
   299   00016c 0610            serdump2:	ld	b, 16
   300   00016e 7e              serdump1:	ld	a, (hl)
   301   00016f cdb601          		call	serhex
   302   000172 cda601          		call	serspace
   303   000175 23              		inc	hl
   304   000176 1b              		dec	de
   305   000177 7a              		ld	a, d
   306   000178 b3              		or	a, e
   307   000179 2807            		jr	z, serdump3
   308   00017b 10f1            		djnz	serdump1
   309   00017d cdae01          		call	sercr
   310   000180 18ea            		jr	serdump2
   311   000182 cdae01          serdump3:	call	sercr
   312   000185 7e              		ld	a, (hl)
   313   000186 cdb601          		call	serhex
   314   000189 cdae01          		call	sercr
   315   00018c c9              		ret
   316                          
   317                          
   318                          ;--------------------------------------------------
   319                          ; RS232 sercmd
   320                          ;--------------------------------------------------
   321   00018d f5              sercmd:		push	af
   322   00018e c5              		push	bc
   323   00018f e5              		push	hl
   324   000190 21fbc2          		ld	hl, CFRAME
   325   000193 0604            		ld	b, 4
   326   000195 7e              sercmd1:	ld	a, (hl)
   327   000196 cdb601          		call	serhex
   328   000199 cda601          		call	serspace
   329   00019c 23              		inc	hl
   330   00019d 10f6            		djnz	sercmd1
   331   00019f cdae01          		call	sercr
   332   0001a2 e1              		pop	hl
   333   0001a3 c1              		pop	bc
   334   0001a4 f1              		pop	af
   335   0001a5 c9              		ret
   336                          
   337                          ;--------------------------------------------------
   338                          ; RS232 <space>
   339                          ;--------------------------------------------------
   340   0001a6 f5              serspace:	push	af
   341   0001a7 3e20            		ld	a, ' '
   342   0001a9 cdcf01          		call	serout
   343   0001ac f1              		pop	af
   344   0001ad c9              		ret
   345                          
   346                          ;--------------------------------------------------
   347                          ; RS232 <CR>
   348                          ;--------------------------------------------------
   349   0001ae f5              sercr:		push	af
   350   0001af 3e0d            		ld	a, '\r'
   351   0001b1 cdcf01          		call	serout
   352   0001b4 f1              		pop	af
   353   0001b5 c9              		ret
   354                          
   355                          ;--------------------------------------------------
   356                          ; RS232 output byte in hex
   357                          ;--------------------------------------------------
   358   0001b6 f5              serhex:		push	af
   359   0001b7 f5              		push	af
   360   0001b8 0f              		rrca
   361   0001b9 0f              		rrca
   362   0001ba 0f              		rrca
   363   0001bb 0f              		rrca
   364   0001bc cdc501          		call	sernib
   365   0001bf f1              		pop	af
   366   0001c0 cdc501          		call	sernib
   367   0001c3 f1              		pop	af
   368   0001c4 c9              		ret
   369                          
   370   0001c5 e60f            sernib:		and	0fh
   371   0001c7 c630            		add	'0'
   372   0001c9 fe3a            		cp	'9' + 1
   373   0001cb 3802            		jr	c, sernib1
   374   0001cd c607            		add	7
   375                          sernib1:
   376                          ;--------------------------------------------------
   377                          ; RS232 out	208 T-States
   378                          ;--------------------------------------------------
   379   0001cf f5              serout:		push	af
   380   0001d0 c5              		push	bc
   381   0001d1 47              		ld	b, a
   382   0001d2 af              		xor	a
   383   0001d3 d351            		out	(SEROUT), a			;startbit
   384   0001d5 cd0402          		call	time19600			;17
   385                          
   386   0001d8 78              		ld	a, b
   387   0001d9 0608            		ld	b, 8				;7
   388   0001db d351            serout1:	out	(SEROUT), a			;11
   389   0001dd cd0402          		call	time19600			;17
   390   0001e0 0f              		rrca					;4
   391   0001e1 10f8            		djnz	serout1				;8
   392                          
   393   0001e3 3e01            		ld	a, 1				;7
   394   0001e5 d351            		out	(SEROUT), a			;11
   395   0001e7 cd0402          		call	time19600			;17
   396                          
   397   0001ea c1              		pop	bc
   398   0001eb f1              		pop	af
   399   0001ec c9              		ret
   400                          
   401                          
   402                          ;--------------------------------------------------
   403                          ; RS232 in	208 T-States
   404                          ;--------------------------------------------------
   405   0001ed c5              serin:		push	bc
   406   0001ee db50            serin2:		in	a, (SERIN)
   407   0001f0 07              		rlca
   408   0001f1 38fb            		jr	c, serin2
   409                          
   410   0001f3 e3              		ex	(sp), hl			;19, 4.75uS
   411   0001f4 e3              		ex	(sp), hl			;19  9uS
   412                          
   413   0001f5 0680            		ld	b, 80h
   414   0001f7 cd0402          serin1:		call	time19600
   415   0001fa db50            		in	a, (SERIN)
   416   0001fc 07              		rlca
   417   0001fd cb18            		rr	b
   418   0001ff 30f6            		jr	nc, serin1
   419                          
   420   000201 78              		ld	a, b
   421   000202 c1              		pop	bc
   422   000203 c9              		ret
   423                          
   424   000204 0e09            time19600:	ld	c, 9				;4
   425   000206 0d              time19600a:	dec	c				;4
   426   000207 20fd            		jr	nz, time19600a			;12/7
   427   000209 c9              		ret					;10
   428                          
   429                          ;		DI
   430                          ;		LD	A,10000111B
   431                          ;		OUT	(CTC3),A
   432                          ;		LD	A,250
   433                          ;		OUT	(CTC3),A
   434                          ;		LD	HL,TMRIRQ
   435                          ;		LD	(CTCVEC+6),HL
   436                          ;		EI
   437                          
   438                          dskloop:
   439                          ;		ld	hl, (TICKS)
   440                          ;		call	putaddr
   441                          ;		jp	dskloop
   442                          
   443   00020a dd213302        		ld	ix, dcb
   444   00020e cd0ff0          		call	dskhandler
   445   000211 cd1a02          		call	dump
   446                          
   447   000214 cd40f6          		call	conin
   448                          
   449   000217 c30a02          		jp	dskloop
   450                          
   451                          
   452   00021a 213302          dump:		ld	hl, dcb
   453   00021d 0609            		ld	b, 9
   454   00021f 7e              loop:		ld	a, (hl)
   455   000220 cd98f4          		call	puthex
   456   000223 23              		inc	hl
   457   000224 10f9            		djnz	loop
   458   000226 c9              		ret
   459                          
   460                          ;		ld	ix, dcb
   461                          ;		call	dskhandler
   462                          ;		ld	hl, dcb
   463                          ;		ld	b, 9
   464                          ;loop1:		ld	a, (hl)
   465                          ;		call	puthex
   466                          ;		inc	hl
   467                          ;		djnz	loop1
   468                          ;
   469                          ;		jp	dskloop
   470                          
   471                          ;
   472                          ;
   473                          ;
   474                          TMRIRQ:
   475   000227 e5              	PUSH	HL
   476   000228 fb              	EI
   477   000229 2ac7ff          	LD	HL,(TICKS)
   478   00022c 23              	INC	HL		;BUMP FREE RUNING MILLISECOND COUNTER
   479   00022d 22c7ff          	LD	(TICKS),HL
   480   000230 e1              	POP	HL
   481   000231 ed4d            	RETI
   482                          
   483                          
   484                          
   485                          
   486   000233 00              dcb:		db	0				;DISK OPERATION CODE
   487   000234 00              		db	0				;DRIVE# (WITH SIDE# IN BIT 7)
   488   000235 00              		db	0				;TRACK#
   489   000236 01              		db	1				;SECTOR#
   490   000237 0080            		dw	8000h				;READ/WRITE POINTER
   491   000239 8000            		dw	128				;AUXILLIARY PARAMETERS (2 BYTES)
   492   00023b 00              		db	0				;OPERATION COMPLETION STATUS
   493                          
   494                          sallycode	equ	ASMPC
   495                          
