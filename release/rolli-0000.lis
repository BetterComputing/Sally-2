rolli-0000.asm:
     1                          
     2                          RIDCMD		equ	11000000B	;READ ID COMMAND
     3                          RDCMD		equ	10000000B	;READ COMMAND
     4                          WRTCMD		equ	10100000B	;WRITE COMMAND
     5                          FINCMD		equ	11010000B	;FORCE INTERRUPT COMMAND
     6                          SKCMD		equ	00010000B	;SEEK COMMAND
     7                          RSTCMD		equ	00000000B	;RESTORE COMMAND
     8                          STEPOUT		equ	01100000B	;STEP OUT COMMAND
     9                          STEPIN		equ	01000000B	;STEP IN COMMAND
    10                          HLOAD		equ	00000000B	;HEAD LOAD BIT FOR TYPE 1 COMMANDS
    11                          
    12                          ;
    13                          ;	... DATA STRUCTURE FOR DISK I/O CONTROL BLOCK ...
    14                          ;
    15                          DSKOP		equ	0		;DISK OPERATION CODE
    16                          DSKDRV		equ	1		;DRIVE# (WITH SIDE# IN BIT 7)
    17                          DSKTRK		equ	2		;TRACK#
    18                          DSKSEC		equ	3		;SECTOR#
    19                          DSKPTR		equ	4		;READ/WRITE POINTER
    20                          DSKAUX		equ	6		;AUXILLIARY PARAMETERS (2 BYTES)
    21                          DSKSTS		equ	8		;OPERATION COMPLETION STATUS
    22                          
    23                          putaddr		equ	0f493h
    24                          puthex		equ	0f498h
    25                          coninit		equ	0f5fch
    26                          conin		equ	0f640h
    27                          conout		equ	0f650h
    28                          SELECT		equ	0f110h
    29                          RESTORE		equ	0f23bh
    30                          SEEKTRK		equ	0f1fch
    31                          RWDISK		equ	0f2b6h
    32                          RENEW		equ	0f018h
    33                          WATCHDOG	equ	0f3a8h
    34                          RECOVER		equ	0f30fh
    35                          ACTIVON		equ	0f03ch
    36                          
    37                          dskhandler	equ	0f00fh
    38                          
    39                          		include "equs.mac"
equs.mac:
     1                          KEYBUF		equ	0ff00h		;16 byte keyboard input fifo
     2                          CTCVEC		equ	0ff10h		;8 word interrupt vector table
     3                          ;
     4                          ;
     5                          ;
     6                          PRINTER		equ	020h		;PRINTER OUTPUT/INPUTS
     7                          LATCH		equ	030h		;DRIVE CONTROL LATCH
     8                          WD179X		equ	040h		;WD TYPE DISK CONTROLLER
     9                          ;
    10                          ;	EQUATES FOR DISK CONTROLLER PORTS AND COMMAND CODES
    11                          ;
    12                          STSREG		equ	WD179X+0	;STATUS REGISTER
    13                          CMDREG		equ	WD179X+0	;COMMAND REGISTER
    14                          TRKREG		equ	WD179X+1	;TRACK REGISTER
    15                          SECREG		equ	WD179X+2	;SECTOR REGISTER
    16                          DATREG		equ	WD179X+3	;DATA REGISTER;
    17                          
    18                          SERIN		equ	050h		;RS232 SERIAL INPUT
    19                          ;
    20                          ATROUT		equ	050h		;ATARI SERIAL OUTPUT
    21                          SEROUT		equ	051h		;RS232 SERIAL OUTPUT
    22                          BANKSW		equ	052h		;ROM BANKSWITCH BIT
    23                          STROBE		equ	053h		;PRINTER STROBE
    24                          INDXCLR		equ	054h		;INDEX CONTROL FLOP CLEAR
    25                          DTR		equ	055h		;DTR OUTPUT CONTROL
    26                          INDXSET		equ	056h		;INDEX CONTROL FLOP SET
    27                          CDMUX		equ	057h		;ATARI CMD/DATA MUX CONTROL
    28                          ;
    29                          ATARI		equ	070h		;ATARI INPUT BITS PORT
    30                          CTC0		equ	080h		;ZILOG COUNTER/TIMER
    31                          CTC1		equ	081h
    32                          CTC2		equ	082h
    33                          CTC3		equ	083h
    34                          ;
    35                          NULL		equ	000h
    36                          CR		equ	00dh
    37                          LF		equ	00ah
    38                          ;
    39                          
rolli-0000.asm:
    40                          		include "global.mac"
global.mac:
     1                          ;********************************************************
     2                          ;*							*
     3                          ;*	GLOBAL VARIABLES FOR ATARI Z80 ROM		*
     4                          ;*							*
     5                          ;********************************************************
     6                          ;
     7                          glbvars	equ	0ff20h
     8                          ;
     9                          ;	... GLOBAL VARIABLES FOR PHYSICAL DISK HANDLER ...
    10                          ;
    11                          ;DRVTAB:	DEFB	255,255,255,255	;HEAD POSITIONS FOR 4 DRIVES
    12                          ;		DEFB	0,0,0,0		;DENSITY/TYPE/SELECT BITS FOR 4 DRIVES
    13                          ;RATES:		DEFB	16,16,16,16	;SETTLING DELAYS / STEP RATES TABLE
    14                          ;UNIT:		DEFB	0		;CURRENTLY SELECTED DISK#
    15                          ;TRACK:		DEFB	255		;TRACK POSITION OF SELECTED DRIVE
    16                          ;DRVOFF:	DEFB	1		;DRIVES-OFF FLAG FROM DISK TIMER IRQ
    17                          ;OUTCPY:	DEFB	00000000B	;COPY OF DISK CONTROL LATCH
    18                          ;PERIOD:	DEFW	0		;DISK SPIN PERIOD
    19                          ;HLDTIM:	DEFB	50		;HEAD LOAD DELAY
    20                          ;RWMAX:		DEFB	10		;MAX NUMBER OF READ/WRITE RETRIES
    21                          ;		DEFB	0,0,0,0		;ROOM FOR EXPANSION
    22                          
    23                          DRVTAB:		equ	glbvars		;HEAD POSITIONS FOR 4 DRIVES
    24                          					;DENSITY/TYPE/SELECT BITS FOR 4 DRIVES
    25                          RATES:		equ	DRVTAB+8	;SETTLING DELAYS / STEP RATES TABLE
    26                          UNIT:		equ	RATES+4		;CURRENTLY SELECTED DISK#
    27                          TRACK:		equ	UNIT+1		;TRACK POSITION OF SELECTED DRIVE
    28                          DRVOFF:		equ	TRACK+1		;DRIVES-OFF FLAG FROM DISK TIMER IRQ
    29                          OUTCPY:		equ 	DRVOFF+1	;COPY OF DISK CONTROL LATCH
    30                          PERIOD:		equ	OUTCPY+1	;DISK SPIN PERIOD
    31                          HLDTIM:		equ	PERIOD+2	;HEAD LOAD DELAY
    32                          RWMAX:		equ	HLDTIM+1	;MAX NUMBER OF READ/WRITE RETRIES
    33                          EXPANSION	equ	RWMAX+1		;ROOM FOR EXPANSION
    34                          ;
    35                          ;
    36                          ;	... GLOBAL VARIABLES FOR ATARI HANDLER ...
    37                          ;
    38                          ;IDPTR:		DEFW	IDTAB		;POINTER TO DEVICE ID TABLE
    39                          ;FSMVEC:	DEFW	PWRWAIT		;POINTER FOR ATARI TASK STATE MACHINE
    40                          ;EXTVEC:	DEFW	DUMMY		;POINTER FOR EXTRA TASK PROCESSOR
    41                          ;NEWLIN:	DEFB	2,CR,LF,0,0	;PRINTER NEWLINE CHARACTERS
    42                          ;PSMSG:		DEFB	0,0,60,0	;PRINTER STATUS FRAME
    43                          ;PMASKS:	DEFB	10000000B	;MASK ALL BITS BUT 'BUSY'
    44                          ;		DEFB	00000000B	;COMPARE TO ZERO FOR READY
    45                          ;FMTPTR:	DEFW	FMTS		;POINTER TO STANDARD FORMAT TABLES
    46                          ;PBASE:		DEFW	IOBUFF+(2*LEN)	;PUT PRINT BUFFER AFTER HERE
    47                          ;PSIZE:		DEFW	4095		;MAX BUFFER INDEX OFFSET
    48                          ;
    49                          ;glbsize	equ	$-glbvars		;length of initialized variables
    50                          ;        DEFB    73h			; **** Exists in original ROM? ****
    51                          IDPTR:		equ	EXPANSION+4	;POINTER TO DEVICE ID TABLE
    52                          FSMVEC:		equ 	IDPTR+2		;POINTER FOR ATARI TASK STATE MACHINE
    53                          EXTVEC:		equ	FSMVEC+2	;POINTER FOR EXTRA TASK PROCESSOR
    54                          NEWLIN:		equ	EXTVEC+2	;PRINTER NEWLINE CHARACTERS
    55                          PSMSG:		equ	NEWLIN+5	;PRINTER STATUS FRAME
    56                          PMASKS:		equ	PSMSG+4		;MASK ALL BITS BUT 'BUSY'
    57                          					;COMPARE TO ZERO FOR READY
    58                          FMTPTR:		equ	PMASKS+2	;POINTER TO STANDARD FORMAT TABLES
    59                          PBASE:		equ	FMTPTR+2	;PUT PRINT BUFFER AFTER HERE
    60                          PSIZE:		equ	PBASE+2		;MAX BUFFER INDEX OFFSET
    61                          
    62                          glbsize	equ	$-glbvars		;length of initialized variables
    63                          ;
    64                          ;
    65                          ;	*** UNINITIALIZED SCRATCH VARIABLES COME AFTER HERE ***
    66                          ;
    67                          PCOUNT:		EQU 	PSIZE+2		;BYTECOUNT FOR BUFFER
    68                          PINP:		EQU 	PCOUNT+2	;INPUT OFFSET
    69                          POUT:		EQU 	PINP+2		;OUTPUT OFFSET
    70                          CMDFLG:		EQU 	POUT+2		;COMMAND FRAME READY FLAG FROM IRQ
    71                          DMATRIX:	EQU 	CMDFLG+1    	;DRIVE POOP TABLES
    72                          OLDPTR:		EQU 	DMATRIX+64	;POINTER TO FIRST DRIVE ACCESSED
    73                          DKIOCB:		EQU 	OLDPTR+2	;DISK I/O COMMAND BLOCK
    74                          DRWCMD:		EQU 	DKIOCB+16	;R/W COMMAND FROM ATARI TO 'DISKIO'
    75                          LOGSIZ:		EQU 	DRWCMD+1	;LOGICAL SECTOR LENGTH FOR XFER
    76                          IDBUF:		EQU	LOGSIZ+2	;BUFFER FOR ID MARK READS
    77                          IOPTR:		EQU 	IDBUF+8		;ATARI BLOCK INPUT POINTER
    78                          VFLAG:		EQU 	IOPTR+2		;VERIFY FLAG FOR DISK WRITES
    79                          
    80                          ;
    81                          ;
    82                          ;	... VARIABLES FOR DISK FORMAT FUNCTION ...
    83                          ;
    84                          FMTSTUFF	EQU	VFLAG+1
    85                          FRMPTR:		EQU 	VFLAG+1			;POINTER TO FORMAT DATA TABLE
    86                          SKWPTR:		EQU 	FRMPTR+2		;POINTER TO SKEW TABLE
    87                          NSECTS:		EQU 	SKWPTR+2		;NUMBER OF SECTORS
    88                          TRKSIZ:		EQU 	NSECTS+1		;TRACK LENGTH IN BYTES
    89                          FMTLEN		EQU	(TRKSIZ+2)-FMTSTUFF
    90                          
    91                          sides:		EQU 	TRKSIZ+2		;copy of 'nsides' for drive#
    92                          tracks:		EQU 	sides+1			;copy of 'ntrks' for drive#
    93                          SEQNUM:		EQU 	tracks+1		;TEMP SECTOR SEQUENCE NUMBER
    94                          SEQPTR:		EQU 	SEQNUM+2		;TEMP ERROR LOG TABLE POINTER
    95                          TRKPTR:		EQU 	SEQPTR+2		;POINTER TO START OF TRACK IMAGE
    96                          
    97                          ;
    98                          ;	... LOCAL VARIABLES FOR DISK HANDLER ...
    99                          ;
   100                          CMDBYT:		EQU 	TRKPTR+2		;COMMAND BYTE FOR READS/WRITES
   101                          RWTRY:		EQU	CMDBYT+1		;READ/WRITE RETRY COUNT
   102                          TICKS:		EQU	RWTRY+1			;FREE RUNNING MILISECOND COUNTER
   103                          DRVTMR:		EQU	TICKS+2			;DISK ACTIVITY TIMER
   104                          ;
   105                          ;
   106                          ;
   107                          ;
   108                          IOBUFF	EQU	0C100H		;ATARI I/O BUFFER
   109                          LEN	EQU	512
   110                          ;
   111                          TRKBUF	EQU	IOBUFF+LEN	;TRACK BUFFER FOR READS
   112                          ;
   113                          
rolli-0000.asm:
    41                          
    42                          ;--------------------------------------------------
    43                          ; Code executed after Reset
    44                          ;--------------------------------------------------
    45                          		ORG	00000h
    46                          ;
    47   000000 f3              reset:		di      				;disable interrupt
    48   000001 af              		xor     a				;set a to zero
    49   000002 3d              restime:	dec     a				;do 256 times nothing
    50   000003 20fd            		jr      nz, restime			;loop
    51                          
    52   000005 21b500          		ld      hl, portval			;init 11 ports with values at 0a3h
    53   000008 060b            		ld      b, 0bh
    54   00000a 4e              portinit:	ld      c, (hl)
    55   00000b 23              		inc     hl
    56   00000c eda3            		outi
    57   00000e 20fa            		jr      nz, portinit			; loop
    58                          
    59                          
    60   000010 2100f0          		ld      hl,0f000h          		;test ram @F000-FFFF
    61   000013 3e01            		ld      a, 01h             		;write 1,2,4,8,16,32,64,128
    62   000015 0610            testram2:	ld      b, 10h
    63   000017 77              testram:	ld      (hl),a
    64   000018 07              		rlca
    65   000019 2c              		inc     l
    66   00001a 20fb            		jr      nz, testram
    67   00001c 24              		inc     h
    68   00001d 10f8            		djnz    testram
    69                          
    70   00001f 0e10            		ld      c, 10h
    71   000021 2b              testram1:	dec     hl
    72   000022 0f              		rrca
    73   000023 be              		cp      (hl)
    74   000024 20fe            ramerr:		jr      nz, ramerr			;if error, loop forever
    75   000026 10f9            		djnz    testram1
    76   000028 0d              		dec     c
    77   000029 20f6            		jr      nz, testram1
    78   00002b 87              		add     a, a
    79   00002c 20e7            		jr      nz, testram2
    80                          
    81   00002e 212301          		ld      hl, sallycode			;copy BIOS 0f000h
    82   000031 1100f0          		ld      de, 0f000h			;length always 0f00h
    83   000034 01000f          		ld      bc, 00f00h
    84   000037 edb0            		ldir
    85   000039 211f10          		ld      hl, sallycode+0efch		;copy initial values to 0ff20h
    86   00003c 1120ff          		ld      de, 0ff20h			;length $2F
    87   00003f 012f00          		ld      bc, 002fh
    88   000042 edb0            		ldir
    89                          
    90   000044 af              		xor     a				;fill up to $FFFF with zeros
    91   000045 12              ramfill:	ld      (de),a
    92   000046 1c              		inc     e
    93   000047 20fc            		jr      nz, ramfill
    94                          
    95   000049 3110ff          		ld      sp, 0ff10h			;stack-pointer to 0ff10h
    96                          
    97   00004c 3eff            		ld      a, 0ffh				;load interrupt-vector register
    98   00004e ed47            		ld      i, a				;with 0ffh
    99   000050 ed5e            		im      2				;enable interrupt mode 2 (vectored)
   100                          
   101                          ;--------------------------------------------------
   102                          ; step 5 times in and then out to trk00
   103                          ; set bit 6 for each online floppy in ff5eh
   104                          ; percom block (16 bytes, byte 8 bit 6)
   105                          ;--------------------------------------------------
   106   000052 3e4f            		ld      a, 4fh				;select drive 1-4, Motor off, side 0, B/S=1, DD
   107   000054 d330            		out     (LATCH),a
   108                          
   109   000056 57              		ld      d, a				;d = 4fh
   110   000057 0605            		ld      b, 5				;step 5 times
   111                          stepin:
   112   000059 3e49            		ld      a, 49h				;4b = 0100 1011 = step-in
   113   00005b cda700          		call    CMDOUT				;write A to FDC command and wait
   114   00005e 10f9            		djnz    stepin
   115                          
   116   000060 0664            		ld      b, 64h				;seek track 00 for all 4 drives
   117   000062 7a              outloop1:	ld      a, d				;select all drives
   118   000063 d330            		out     (LATCH),a
   119   000065 e3              		ex      (sp),hl				;???
   120   000066 e3              		ex      (sp),hl				;???
   121   000067 3e69            		ld      a, 69h				;step out
   122   000069 cda700          		call    CMDOUT				;write A to FDC command and wait
   123                          
   124   00006c 1e01            		ld      e, 01h
   125   00006e 7b              outloop:	ld      a, e
   126   00006f f640            		or      40h
   127   000071 d330            		out     (LATCH), a			;select one drive
   128   000073 e3              		ex      (sp), hl
   129   000074 e3              		ex      (sp), hl
   130                          ;		call    0f391h				;stop command, get status
   131   000075 db40            		in	a, (STSREG)
   132   000077 cb57            		bit     2, a
   133   000079 2804            		jr      z, excldrv			;bit not set, not at track 00
   134   00007b 7b              		ld      a, e				;drive at track 00
   135   00007c 2f              		cpl     				;exclude drive from seeking
   136   00007d a2              		and     d
   137   00007e 57              		ld      d, a
   138                          excldrv:
   139   00007f cb23            		sla     e
   140   000081 cb63            		bit     4, e
   141   000083 28e9            		jr      z, outloop			;status checked for all 4 drives?
   142   000085 10db            		djnz    outloop1			;step out again
   143                          
   144                          ;		call    0f068h				;deselect floppies and seek current track?
   145   000087 3e50            		ld	a, 50h				;reset FDC and deselct
   146   000089 d330            		out	(LATCH), a
   147   00008b 3e40            		ld	a, 40h				;reset FDC and deselct
   148   00008d d330            		out	(LATCH), a
   149                          
   150   00008f 215eff          		ld      hl, 0ff5eh			;set bit for each connected floppy?
   151   000092 011000          		ld      bc, 0010h
   152   000095 3e04            		ld      a, 04h
   153   000097 cb1a            nextdrv:	rr      d
   154   000099 3802            		jr      c, noset
   155   00009b cbf6            		set     6, (hl)
   156   00009d 09              noset:		add     hl, bc
   157   00009e 3d              		dec     a
   158   00009f 20f6            		jr      nz, nextdrv
   159                          
   160   0000a1 3100c1          		ld      sp, 0c100h			;set stack to 0c100h
   161   0000a4 c362f7          		jp      0f762h				;jump to code in DRAM
   162                          ;		jp	0f003h
   163                          ;		jp	main
   164                          
   165                          CMDOUT:
   166   0000a7 d340            		OUT	(CMDREG),A			;OUTPUT DISK CONTROLLER COMMAND BYTE
   167   0000a9 3e0e            CMDT1:		LD	A,14
   168   0000ab 3d              CMDT2:		DEC	A
   169   0000ac 20fd            		JR	NZ,CMDT2			;DELAY 56 MICROSECONDS
   170   0000ae db40            CMDT3:		in	a, (STSREG)
   171   0000b0 cb47            		bit	0, a
   172   0000b2 20fa            		jr	nz, CMDT3
   173   0000b4 c9              		RET
   174                          
   175                          ;--------------------------------------------------
   176                          ; 11 times port:value
   177                          ;--------------------------------------------------
   178   0000b5 5001            portval:	db	050h, 001h			;Bit0	set ATARI DATA
   179   0000b7 5101            		db	051h, 001h			;Bit1	set RS232 TX
   180   0000b9 8003            		db	080h, 003h			;CTC	Channel 0 reset
   181   0000bb 8010            		db 	080h, 010h			;CTC	Channel 0 interrupt vector
   182   0000bd 8107            		db	081h, 007h			;CTC	Channel 1 reset + set time constant
   183   0000bf 8101            		db	081h, 001h			;CTC	Channel 1 time contant
   184   0000c1 8203            		db	082h, 003h			;CTC	Channel 2 reset
   185   0000c3 8303            		db	083h, 003h			;CTC	Channel 3 reset
   186   0000c5 5701            		db	057h, 001h			;Bit7	ATARI RXD
   187   0000c7 3050            		db	030h, 050h			;DRIVE CONTROL reset FDC
   188   0000c9 3040            		db	030h, 040h			;DRIVE CONTROL 8Mhz
   189                          
   190                          main:
   191   0000cb 210000          		ld	hl, 00000h			; source
   192   0000ce 110080          		ld	de, 08000h			; dest
   193   0000d1 010020          		ld	bc, 02000h
   194   0000d4 edb0            		ldir
   195   0000d6 21dc00          		ld	hl, code8000
   196   0000d9 cbfc            		set	7, h
   197   0000db e9              		jp	(hl)
   198   0000dc 3e01            code8000:	ld	a, 1
   199   0000de d352            		out	(BANKSW), a
   200   0000e0 210080          		ld	hl, 08000h
   201   0000e3 110000          		ld	de, 00000h
   202   0000e6 010020          		ld	bc, 02000h
   203   0000e9 edb0            		ldir
   204   0000eb c3ee00          		jp	code0000
   205                          
   206   0000ee cdfcf5          code0000:	call	0f5fch				;coninit
   207                          
   208                          
   209                          ;		DI
   210                          ;		LD	A,10000111B
   211                          ;		OUT	(CTC3),A
   212                          ;		LD	A,250
   213                          ;		OUT	(CTC3),A
   214                          ;		LD	HL,TMRIRQ
   215                          ;		LD	(CTCVEC+6),HL
   216                          ;		EI
   217                          
   218                          dskloop:
   219                          ;		ld	hl, (TICKS)
   220                          ;		call	putaddr
   221                          ;		jp	dskloop
   222                          
   223   0000f1 dd211a01        		ld	ix, dcb
   224   0000f5 cd0ff0          		call	dskhandler
   225   0000f8 cd0101          		call	dump
   226                          
   227   0000fb cd40f6          		call	conin
   228                          
   229   0000fe c3f100          		jp	dskloop
   230                          
   231                          
   232   000101 211a01          dump:		ld	hl, dcb
   233   000104 0609            		ld	b, 9
   234   000106 7e              loop:		ld	a, (hl)
   235   000107 cd98f4          		call	puthex
   236   00010a 23              		inc	hl
   237   00010b 10f9            		djnz	loop
   238   00010d c9              		ret
   239                          
   240                          ;		ld	ix, dcb
   241                          ;		call	dskhandler
   242                          ;		ld	hl, dcb
   243                          ;		ld	b, 9
   244                          ;loop1:		ld	a, (hl)
   245                          ;		call	puthex
   246                          ;		inc	hl
   247                          ;		djnz	loop1
   248                          ;
   249                          ;		jp	dskloop
   250                          
   251                          ;
   252                          ;
   253                          ;
   254                          TMRIRQ:
   255   00010e e5              	PUSH	HL
   256   00010f fb              	EI
   257   000110 2ac7ff          	LD	HL,(TICKS)
   258   000113 23              	INC	HL		;BUMP FREE RUNING MILLISECOND COUNTER
   259   000114 22c7ff          	LD	(TICKS),HL
   260   000117 e1              	POP	HL
   261   000118 ed4d            	RETI
   262                          
   263                          
   264                          
   265                          
   266   00011a 00              dcb:		db	0				;DISK OPERATION CODE
   267   00011b 00              		db	0				;DRIVE# (WITH SIDE# IN BIT 7)
   268   00011c 00              		db	0				;TRACK#
   269   00011d 01              		db	1				;SECTOR#
   270   00011e 0080            		dw	8000h				;READ/WRITE POINTER
   271   000120 8000            		dw	128				;AUXILLIARY PARAMETERS (2 BYTES)
   272   000122 00              		db	0				;OPERATION COMPLETION STATUS
   273                          
   274                          sallycode	equ	ASMPC
   275                          
